From 736cd4166d7265e6b1092a4bc570682f1dab69aa Mon Sep 17 00:00:00 2001
From: StanleyYP Wang <StanleyYP.Wang@mediatek.com>
Date: Wed, 4 Dec 2024 17:54:39 +0800
Subject: [PATCH 060/105] mtk: mt76: mt7996: add beacon waiting mechanism for
 active scanning on radar channel

For radar/no-IR channels, the scan defaults to passive scanning.
However, if beacons/probe resps are received on this channel, then
the scan can be upgraded to active scanning.
This helps the STA scan for the hidden root AP on DFS channels.

Clear MT76_SCANNING_WAIT_BEACON & MT76_SCANNING_BEACON_DONE flag if
scanning is completed

Signed-off-by: StanleyYP Wang <StanleyYP.Wang@mediatek.com>
---
 mt76.h       |  2 ++
 mt7996/mac.c | 23 +++++++++++++++++++++++
 scan.c       | 25 ++++++++++++++++++++++++-
 3 files changed, 49 insertions(+), 1 deletion(-)

diff --git a/mt76.h b/mt76.h
index 17436df68..406680239 100644
--- a/mt76.h
+++ b/mt76.h
@@ -604,6 +604,8 @@ enum {
 	MT76_STATE_ROC,
 	MT76_STATE_PM,
 	MT76_STATE_WED_RESET,
+	MT76_SCANNING_WAIT_BEACON,
+	MT76_SCANNING_BEACON_DONE,
 };
 
 enum mt76_sta_event {
diff --git a/mt7996/mac.c b/mt7996/mac.c
index 9dea71c48..36db0473d 100644
--- a/mt7996/mac.c
+++ b/mt7996/mac.c
@@ -14,6 +14,8 @@
 #include "vendor.h"
 #include "mt7996_trace.h"
 
+static void mt7996_scan_rx(struct mt7996_phy *phy);
+
 static struct mt76_wcid *mt7996_rx_get_wcid(struct mt7996_dev *dev,
 					    u16 idx, u8 band_idx)
 {
@@ -576,6 +578,10 @@ mt7996_mac_fill_rx(struct mt7996_dev *dev, enum mt76_rxq_id q,
 
 		hdr = mt76_skb_get_hdr(skb);
 		fc = hdr->frame_control;
+
+		if (unlikely(ieee80211_is_probe_resp(fc) || ieee80211_is_beacon(fc)))
+			mt7996_scan_rx(phy);
+
 		if (ieee80211_is_data_qos(fc)) {
 			u8 *qos = ieee80211_get_qos_ctl(hdr);
 
@@ -3344,6 +3350,23 @@ void mt7996_mac_twt_teardown_flow(struct mt7996_dev *dev,
 	dev->twt.n_agrt--;
 }
 
+static void mt7996_scan_rx(struct mt7996_phy *phy)
+{
+	struct mt76_dev *dev = &phy->dev->mt76;
+	struct ieee80211_vif *vif = dev->scan.vif;
+	struct mt7996_vif *mvif;
+
+	if (!vif || !test_bit(MT76_SCANNING, &phy->mt76->state))
+		return;
+
+	if (test_and_clear_bit(MT76_SCANNING_WAIT_BEACON, &phy->mt76->state)) {
+		mvif = (struct mt7996_vif *)vif->drv_priv;
+		set_bit(MT76_SCANNING_BEACON_DONE, &phy->mt76->state);
+		cancel_delayed_work(&dev->scan_work);
+		ieee80211_queue_delayed_work(phy->mt76->hw, &dev->scan_work, 0);
+	}
+}
+
 static int
 mt7996_beacon_mon_send_probe(struct mt7996_phy *phy, struct mt7996_vif *mvif,
 			     struct ieee80211_bss_conf *conf, unsigned int link_id)
diff --git a/scan.c b/scan.c
index 2eb0e25f9..06203c280 100644
--- a/scan.c
+++ b/scan.c
@@ -15,6 +15,8 @@ static void mt76_scan_complete(struct mt76_dev *dev, bool abort)
 		return;
 
 	clear_bit(MT76_SCANNING, &phy->state);
+	clear_bit(MT76_SCANNING_WAIT_BEACON, &phy->state);
+	clear_bit(MT76_SCANNING_BEACON_DONE, &phy->state);
 
 	if (dev->scan.chan && phy->main_chandef.chan &&
 	    !test_bit(MT76_MCU_RESET, &dev->phy.state))
@@ -89,11 +91,26 @@ void mt76_scan_work(struct work_struct *work)
 	int duration = HZ / 9; /* ~110 ms */
 	int i;
 
+	clear_bit(MT76_SCANNING_WAIT_BEACON, &phy->state);
+
 	if (dev->scan.chan_idx >= req->n_channels) {
 		mt76_scan_complete(dev, false);
 		return;
 	}
 
+	/* move to active scan for the current scanning channel */
+	if (test_and_clear_bit(MT76_SCANNING_BEACON_DONE, &phy->state)) {
+		local_bh_disable();
+		for (i = 0; i < req->n_ssids; i++)
+			mt76_scan_send_probe(dev, &req->ssids[i]);
+		local_bh_enable();
+		ieee80211_queue_delayed_work(phy->hw, &dev->scan_work, HZ / 16);
+		mt76_dbg(dev, MT76_DBG_SCAN,
+			 "%s: move to active scan on channel %d\n",
+			 __func__, phy->chandef.center_freq1);
+		return;
+	}
+
 	if (dev->scan.chan && phy->num_sta) {
 		dev->scan.chan = NULL;
 		mt76_set_channel(phy, &phy->main_chandef, false);
@@ -105,8 +122,14 @@ void mt76_scan_work(struct work_struct *work)
 	mt76_set_channel(phy, &chandef, true);
 
 	if (!req->n_ssids ||
-	    chandef.chan->flags & (IEEE80211_CHAN_NO_IR | IEEE80211_CHAN_RADAR))
+	    chandef.chan->flags & (IEEE80211_CHAN_NO_IR | IEEE80211_CHAN_RADAR)) {
+		/* allow active scan on radar/no-IR channels
+		 * if beacons from other APs are received
+		 */
+		if (req->n_ssids)
+			set_bit(MT76_SCANNING_WAIT_BEACON, &phy->state);
 		goto out;
+	}
 
 	duration = HZ / 16; /* ~60 ms */
 	local_bh_disable();
-- 
2.45.2

