From 7a42f7779e95e547fc11ae4842b3b007104d8ca5 Mon Sep 17 00:00:00 2001
From: Rex Lu <rex.lu@mediatek.com>
Date: Wed, 21 Aug 2024 18:11:43 +0800
Subject: [PATCH 039/105] mtk: mt76: mt7996: SER support hw detect only mode

1. add support SER hw detect only mode

Signed-off-by: Rex Lu <rex.lu@mediatek.com>
---
 mt7996/debugfs.c | 20 ++++++++++++++++++--
 mt7996/mcu.h     |  5 +++++
 2 files changed, 23 insertions(+), 2 deletions(-)

diff --git a/mt7996/debugfs.c b/mt7996/debugfs.c
index 76d623b2c..9b29f16c8 100644
--- a/mt7996/debugfs.c
+++ b/mt7996/debugfs.c
@@ -87,6 +87,9 @@ mt7996_sys_recovery_set(struct file *file, const char __user *user_buf,
 	 * <band>,7: trigger & enable system error L4 mdp recovery.
 	 * <band>,8: trigger & enable system error full recovery.
 	 * <band>,9: trigger firmware crash.
+	 * 10: trigger grab wa firmware coredump.
+	 * 11: trigger grab wm firmware coredump.
+	 * 12: hw bit detect only.
 	 */
 	case UNI_CMD_SER_QUERY:
 		ret = mt7996_mcu_set_ser(dev, UNI_CMD_SER_QUERY, 0, band);
@@ -118,6 +121,11 @@ mt7996_sys_recovery_set(struct file *file, const char __user *user_buf,
 		if (ret)
 			return ret;
 		break;
+	case UNI_CMD_SER_SET_HW_BIT_DETECT_ONLY:
+		ret = mt7996_mcu_set_ser(dev, UNI_CMD_SER_SET, BIT(0), band);
+		if (ret)
+			return ret;
+		break;
 	default:
 		break;
 	}
@@ -133,7 +141,7 @@ mt7996_sys_recovery_get(struct file *file, char __user *user_buf,
 	char *buff;
 	int desc = 0;
 	ssize_t ret;
-	static const size_t bufsz = 1024;
+	static const size_t bufsz = 1536;
 
 	buff = kmalloc(bufsz, GFP_KERNEL);
 	if (!buff)
@@ -162,7 +170,15 @@ mt7996_sys_recovery_get(struct file *file, char __user *user_buf,
 			  "<band>,8: trigger system error full recovery\n");
 	desc += scnprintf(buff + desc, bufsz - desc,
 			  "<band>,9: trigger firmware crash\n");
-
+	desc += scnprintf(buff + desc, bufsz - desc,
+			  "%2d: trigger grab wa firmware coredump\n",
+			  UNI_CMD_SER_FW_COREDUMP_WA);
+	desc += scnprintf(buff + desc, bufsz - desc,
+			  "%2d: trigger grab wm firmware coredump\n",
+			  UNI_CMD_SER_FW_COREDUMP_WM);
+	desc += scnprintf(buff + desc, bufsz - desc,
+			  "%2d: hw bit detect only\n",
+			  UNI_CMD_SER_SET_HW_BIT_DETECT_ONLY);
 	/* SER statistics */
 	desc += scnprintf(buff + desc, bufsz - desc,
 			  "\nlet's dump firmware SER statistics...\n");
diff --git a/mt7996/mcu.h b/mt7996/mcu.h
index 2f7fdc70d..e59b0b050 100644
--- a/mt7996/mcu.h
+++ b/mt7996/mcu.h
@@ -945,6 +945,11 @@ enum {
 	UNI_CMD_SER_SET_RECOVER_FROM_ETH,
 	UNI_CMD_SER_SET_RECOVER_FULL = 8,
 	UNI_CMD_SER_SET_SYSTEM_ASSERT,
+	/* coredump */
+	UNI_CMD_SER_FW_COREDUMP_WA,
+	UNI_CMD_SER_FW_COREDUMP_WM,
+	/*hw bit detect only*/
+	UNI_CMD_SER_SET_HW_BIT_DETECT_ONLY,
 	/* action */
 	UNI_CMD_SER_ENABLE = 1,
 	UNI_CMD_SER_SET,
-- 
2.45.2

