From 184bd0b69a551ddae5e85272103128cc2f739433 Mon Sep 17 00:00:00 2001
From: Benjamin Lin <benjamin-jw.lin@mediatek.com>
Date: Thu, 1 Aug 2024 09:11:02 +0800
Subject: [PATCH 023/105] mtk: mt76: mt7996: record per-antenna average
 data-frame RSSI

Record per-antenna average data-frame RSSI.

Signed-off-by: Benjamin Lin <benjamin-jw.lin@mediatek.com>
---
 mt7996/mac.c | 17 +++++++++++++++--
 1 file changed, 15 insertions(+), 2 deletions(-)

diff --git a/mt7996/mac.c b/mt7996/mac.c
index bc482545d..5f92e1ab7 100644
--- a/mt7996/mac.c
+++ b/mt7996/mac.c
@@ -436,6 +436,7 @@ mt7996_mac_fill_rx(struct mt7996_dev *dev, enum mt76_rxq_id q,
 	int idx;
 	u8 hw_aggr = false;
 	struct mt7996_sta *msta = NULL;
+	struct mt7996_sta_link *msta_link = NULL;
 
 	hw_aggr = status->aggr;
 	memset(status, 0, sizeof(*status));
@@ -464,8 +465,6 @@ mt7996_mac_fill_rx(struct mt7996_dev *dev, enum mt76_rxq_id q,
 	status->wcid = mt7996_rx_get_wcid(dev, idx, band_idx);
 
 	if (status->wcid) {
-		struct mt7996_sta_link *msta_link;
-
 		msta_link = container_of(status->wcid, struct mt7996_sta_link,
 					 wcid);
 		msta = msta_link->sta;
@@ -591,6 +590,20 @@ mt7996_mac_fill_rx(struct mt7996_dev *dev, enum mt76_rxq_id q,
 		status->chain_signal[2] = to_rssi(MT_PRXV_RCPI2, v3);
 		status->chain_signal[3] = to_rssi(MT_PRXV_RCPI3, v3);
 
+		if (msta_link) {
+			int i;
+
+			memcpy(msta_link->chain_signal, status->chain_signal,
+			       IEEE80211_MAX_CHAINS);
+			msta_link->signal = mt76_rx_signal(mphy->antenna_mask,
+							   msta_link->chain_signal);
+
+			for (i = 0; i < IEEE80211_MAX_CHAINS; ++i)
+				ewma_avg_signal_add(msta_link->chain_signal_avg + i,
+						    -msta_link->chain_signal[i]);
+			ewma_avg_signal_add(&msta_link->signal_avg, -msta_link->signal);
+		}
+
 		/* RXD Group 5 - C-RXV */
 		if (rxd1 & MT_RXD1_NORMAL_GROUP_5) {
 			rxd += 24;
-- 
2.45.2

