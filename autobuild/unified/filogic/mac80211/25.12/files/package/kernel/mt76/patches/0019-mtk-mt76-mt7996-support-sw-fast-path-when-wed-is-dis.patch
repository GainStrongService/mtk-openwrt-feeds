From b285c064ad4802956325d9c5451cbd437846f0bf Mon Sep 17 00:00:00 2001
From: Peter Chiu <chui-hao.chiu@mediatek.com>
Date: Thu, 14 Aug 2025 16:12:11 +0800
Subject: [PATCH 019/105] mtk: mt76: mt7996: support sw fast path when wed is
 disabled

When wed is disabled, net_fill_forward_path would still be called
when using sw fast path. If this is not defined or return error,
it cannot use sw fast path. So do not return error and fill in the
required fields.

Signed-off-by: Peter Chiu <chui-hao.chiu@mediatek.com>
---
 mt7996/main.c | 11 ++++++++---
 1 file changed, 8 insertions(+), 3 deletions(-)

diff --git a/mt7996/main.c b/mt7996/main.c
index 9349b1f0f..06a798ecc 100644
--- a/mt7996/main.c
+++ b/mt7996/main.c
@@ -2219,6 +2219,8 @@ mt7996_net_fill_forward_path(struct ieee80211_hw *hw,
 			     struct net_device_path_ctx *ctx,
 			     struct net_device_path *path)
 {
+#ifdef CONFIG_NET_MEDIATEK_SOC_WED
+	struct mt7996_vif *mvif = (struct mt7996_vif *)vif->drv_priv;
 	struct mt7996_sta *msta = (struct mt7996_sta *)sta->drv_priv;
 	struct mt7996_dev *dev = mt7996_hw_dev(hw);
 	struct mtk_wed_device *wed = &dev->mt76.mmio.wed;
@@ -2243,10 +2245,8 @@ mt7996_net_fill_forward_path(struct ieee80211_hw *hw,
 
 	if (!mtk_wed_device_active(wed) &&
 	    !mt76_npu_device_active(&dev->mt76))
-		return -ENODEV;
+		goto out;
 
-	path->type = DEV_PATH_MTK_WDMA;
-	path->dev = ctx->dev;
 #ifdef CONFIG_NET_MEDIATEK_SOC_WED
 	if (mtk_wed_device_active(wed))
 		path->mtk_wdma.wdma_idx = wed->wdma_idx;
@@ -2262,6 +2262,11 @@ mt7996_net_fill_forward_path(struct ieee80211_hw *hw,
 		path->mtk_wdma.amsdu = msta_link->wcid.amsdu;
 	else
 		path->mtk_wdma.amsdu = 0;
+
+out:
+#endif
+	path->type = DEV_PATH_MTK_WDMA;
+	path->dev = ctx->dev;
 	ctx->dev = NULL;
 
 	return 0;
-- 
2.45.2

