From 766e3d1147fb797470cad9de1873db9a9b5319e1 Mon Sep 17 00:00:00 2001
From: Shayne Chen <shayne.chen@mediatek.com>
Date: Thu, 6 Nov 2025 16:50:41 +0800
Subject: [PATCH 040/105] mtk: mt76: mt7996: add mt7996_sta to mt7996_vif

Provide a way to find ieee80211_vif from VIF wcid.

---
 mt7996/main.c   | 5 +++++
 mt7996/mt7996.h | 2 ++
 2 files changed, 7 insertions(+)

diff --git a/mt7996/main.c b/mt7996/main.c
index 3c7cf3ea3..9f5b407af 100644
--- a/mt7996/main.c
+++ b/mt7996/main.c
@@ -341,6 +341,9 @@ int mt7996_vif_link_add(struct mt76_phy *mphy, struct ieee80211_vif *vif,
 	msta_link->wcid.tx_info |= MT_WCID_TX_INFO_SET;
 	mt76_wcid_init(&msta_link->wcid, band_idx);
 
+	msta_link->sta = &mvif->sta;
+	msta_link->sta->vif = mvif;
+
 	mt7996_mac_wtbl_update(dev, idx,
 			       MT_WTBL_UPDATE_ADM_COUNT_CLEAR);
 
@@ -368,6 +371,7 @@ int mt7996_vif_link_add(struct mt76_phy *mphy, struct ieee80211_vif *vif,
 		mt7996_mcu_add_sta(dev, link_conf, NULL, link, NULL,
 				   CONN_STATE_PORT_SECURE, true);
 	rcu_assign_pointer(dev->mt76.wcid[idx], &msta_link->wcid);
+	rcu_assign_pointer(mvif->sta.link[link_conf->link_id], msta_link);
 
 	ieee80211_iter_keys(mphy->hw, vif, mt7996_key_iter, &it);
 
@@ -403,6 +407,7 @@ void mt7996_vif_link_remove(struct mt76_phy *mphy, struct ieee80211_vif *vif,
 	mt7996_mcu_add_dev_info(phy, vif, link_conf, mlink, false);
 
 	rcu_assign_pointer(dev->mt76.wcid[idx], NULL);
+	rcu_assign_pointer(mvif->sta.link[link_conf->link_id], NULL);
 
 	if (!mlink->wcid->offchannel &&
 	    mvif->mt76.deflink_id == link_conf->link_id) {
diff --git a/mt7996/mt7996.h b/mt7996/mt7996.h
index fa415db55..9911185bb 100644
--- a/mt7996/mt7996.h
+++ b/mt7996/mt7996.h
@@ -270,6 +270,8 @@ struct mt7996_vif {
 
 	struct mt7996_vif_link_info link_info[IEEE80211_MLD_MAX_NUM_LINKS];
 
+	struct mt7996_sta sta;
+
 	u8 mld_group_idx;
 	u8 mld_remap_idx;
 
-- 
2.45.2

