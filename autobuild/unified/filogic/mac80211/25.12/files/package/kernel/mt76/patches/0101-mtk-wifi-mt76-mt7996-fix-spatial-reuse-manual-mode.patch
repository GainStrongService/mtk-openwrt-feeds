From 7ebf46cfc32a44b34ca1cc2fb14261ccda575a73 Mon Sep 17 00:00:00 2001
From: StanleyYP Wang <StanleyYP.Wang@mediatek.com>
Date: Wed, 10 Dec 2025 19:01:09 +0800
Subject: [PATCH 101/105] mtk: wifi: mt76: mt7996: fix spatial reuse manual
 mode

Fix spatial reuse manual mode

Signed-off-by: StanleyYP Wang <StanleyYP.Wang@mediatek.com>
---
 mt7996/mcu.c | 77 ++++++++++++++++++++++++++++++----------------------
 1 file changed, 45 insertions(+), 32 deletions(-)

diff --git a/mt7996/mcu.c b/mt7996/mcu.c
index 6b7796854..c4a5d9a7b 100644
--- a/mt7996/mcu.c
+++ b/mt7996/mcu.c
@@ -6817,8 +6817,11 @@ static int
 mt7996_mcu_set_obss_spr_pd(struct mt7996_phy *phy,
 			   struct ieee80211_he_obss_pd *he_obss_pd)
 {
+#define SR_PD_MAX				-62
+#define SR_PD_MIN				-82
+#define SR_TXPOWER_RESTRICT_FOLLOW_MTK		2
+#define SR_TXPOWER_REF				21
 	struct mt7996_dev *dev = phy->dev;
-	u8 max_th = 82, non_srg_max_th = 62;
 	struct {
 		u8 band_idx;
 		u8 __rsv[3];
@@ -6826,45 +6829,45 @@ mt7996_mcu_set_obss_spr_pd(struct mt7996_phy *phy,
 		__le16 tag;
 		__le16 len;
 
-		u8 pd_th_non_srg;
-		u8 pd_th_srg;
+		u8 pd_th_non_srg;		/* dBm */
+		u8 pd_th_srg;			/* dBm */
 		u8 period_offs;
 		u8 rcpi_src;
-		__le16 obss_pd_min;
-		__le16 obss_pd_min_srg;
-		u8 resp_txpwr_mode;
-		u8 txpwr_restrict_mode;
+		__le16 obss_pd_min;		/* dBm */
+		__le16 obss_pd_min_srg;		/* dBm */
+		__le32 resp_txpwr_mode;
+		__le32 txpwr_restrict_mode;
 		u8 txpwr_ref;
 		u8 __rsv2[3];
 	} __packed req = {
 		.band_idx = phy->mt76->band_idx,
 		.tag = cpu_to_le16(UNI_CMD_SR_SET_PARAM),
 		.len = cpu_to_le16(sizeof(req) - 4),
-		.obss_pd_min = cpu_to_le16(max_th),
-		.obss_pd_min_srg = cpu_to_le16(max_th),
-		.txpwr_restrict_mode = 2,
-		.txpwr_ref = 21
+		.obss_pd_min = cpu_to_le16(SR_PD_MIN),
+		.obss_pd_min_srg = cpu_to_le16(SR_PD_MIN),
+		.txpwr_restrict_mode = cpu_to_le32(SR_TXPOWER_RESTRICT_FOLLOW_MTK),
+		.txpwr_ref = SR_TXPOWER_REF,
 	};
 	int ret;
 
-	/* disable firmware dynamical PD asjustment */
+	/* disable firmware dynamic PD adjustment */
 	ret = mt7996_mcu_enable_obss_spr(phy, UNI_CMD_SR_ENABLE_DPD, false);
 	if (ret)
 		return ret;
 
 	if (he_obss_pd->sr_ctrl &
 	    IEEE80211_HE_SPR_NON_SRG_OBSS_PD_SR_DISALLOWED)
-		req.pd_th_non_srg = max_th;
+		req.pd_th_non_srg = SR_PD_MIN;
 	else if (he_obss_pd->sr_ctrl & IEEE80211_HE_SPR_NON_SRG_OFFSET_PRESENT)
-		req.pd_th_non_srg  = max_th - he_obss_pd->non_srg_max_offset;
+		req.pd_th_non_srg  = SR_PD_MIN + he_obss_pd->non_srg_max_offset;
 	else
-		req.pd_th_non_srg  = non_srg_max_th;
+		req.pd_th_non_srg  = SR_PD_MAX;
 
 	if (he_obss_pd->sr_ctrl & IEEE80211_HE_SPR_SRG_INFORMATION_PRESENT)
-		req.pd_th_srg = max_th - he_obss_pd->max_offset;
+		req.pd_th_srg = SR_PD_MIN + he_obss_pd->max_offset;
 
 	return mt76_mcu_send_msg(&dev->mt76, MCU_WM_UNI_CMD(SR),
-				 &req, sizeof(req), true);
+				 &req, sizeof(req), false);
 }
 
 static int
@@ -6872,6 +6875,9 @@ mt7996_mcu_set_obss_spr_siga(struct mt7996_phy *phy,
 			     struct mt7996_vif_link *link,
 			     struct ieee80211_he_obss_pd *he_obss_pd)
 {
+#define SR_MODE_SINGLE_AP	0
+#define SR_BSSID_NUM		20
+#define SR_BSSID_OMAC_OFFSET	12
 	struct mt7996_dev *dev = phy->dev;
 	u8 omac = link->mt76.omac_idx;
 	struct {
@@ -6883,27 +6889,32 @@ mt7996_mcu_set_obss_spr_siga(struct mt7996_phy *phy,
 
 		u8 omac;
 		u8 __rsv2[3];
-		u8 flag[20];
+		u8 flag[SR_BSSID_NUM];
 	} __packed req = {
 		.band_idx = phy->mt76->band_idx,
 		.tag = cpu_to_le16(UNI_CMD_SR_SET_SIGA),
 		.len = cpu_to_le16(sizeof(req) - 4),
-		.omac = omac > HW_BSSID_MAX ? omac - 12 : omac,
 	};
 	int ret;
 
-	if (he_obss_pd->sr_ctrl & IEEE80211_HE_SPR_HESIGA_SR_VAL15_ALLOWED)
-		req.flag[req.omac] = 0xf;
-	else
+	if (!(he_obss_pd->sr_ctrl & IEEE80211_HE_SPR_HESIGA_SR_VAL15_ALLOWED))
 		return 0;
 
 	/* switch to normal AP mode */
-	ret = mt7996_mcu_enable_obss_spr(phy, UNI_CMD_SR_ENABLE_MODE, 0);
+	ret = mt7996_mcu_enable_obss_spr(phy, UNI_CMD_SR_ENABLE_MODE,
+					 SR_MODE_SINGLE_AP);
 	if (ret)
 		return ret;
 
+	if (omac >= SR_BSSID_OMAC_OFFSET)
+		req.omac = omac - SR_BSSID_OMAC_OFFSET;
+	else
+		req.omac = omac;
+
+	req.flag[req.omac] = 0xf;
+
 	return mt76_mcu_send_msg(&dev->mt76, MCU_WM_UNI_CMD(SR),
-				 &req, sizeof(req), true);
+				 &req, sizeof(req), false);
 }
 
 static int
@@ -6918,10 +6929,12 @@ mt7996_mcu_set_obss_spr_bitmap(struct mt7996_phy *phy,
 		__le16 tag;
 		__le16 len;
 
-		__le32 color_l[2];
-		__le32 color_h[2];
-		__le32 bssid_l[2];
-		__le32 bssid_h[2];
+		struct {
+			__le32 color_l;
+			__le32 color_h;
+			__le32 bssid_l;
+			__le32 bssid_h;
+		} spr_bitmap[__MT_MAX_BAND];
 	} __packed req = {
 		.band_idx = phy->mt76->band_idx,
 		.tag = cpu_to_le16(UNI_CMD_SR_SET_SRG_BITMAP),
@@ -6930,16 +6943,16 @@ mt7996_mcu_set_obss_spr_bitmap(struct mt7996_phy *phy,
 	u32 bitmap;
 
 	memcpy(&bitmap, he_obss_pd->bss_color_bitmap, sizeof(bitmap));
-	req.color_l[req.band_idx] = cpu_to_le32(bitmap);
+	req.spr_bitmap[req.band_idx].color_l = cpu_to_le32(bitmap);
 
 	memcpy(&bitmap, he_obss_pd->bss_color_bitmap + 4, sizeof(bitmap));
-	req.color_h[req.band_idx] = cpu_to_le32(bitmap);
+	req.spr_bitmap[req.band_idx].color_h = cpu_to_le32(bitmap);
 
 	memcpy(&bitmap, he_obss_pd->partial_bssid_bitmap, sizeof(bitmap));
-	req.bssid_l[req.band_idx] = cpu_to_le32(bitmap);
+	req.spr_bitmap[req.band_idx].bssid_l = cpu_to_le32(bitmap);
 
 	memcpy(&bitmap, he_obss_pd->partial_bssid_bitmap + 4, sizeof(bitmap));
-	req.bssid_h[req.band_idx] = cpu_to_le32(bitmap);
+	req.spr_bitmap[req.band_idx].bssid_h = cpu_to_le32(bitmap);
 
 	return mt76_mcu_send_msg(&dev->mt76, MCU_WM_UNI_CMD(SR), &req,
 				 sizeof(req), true);
-- 
2.45.2

