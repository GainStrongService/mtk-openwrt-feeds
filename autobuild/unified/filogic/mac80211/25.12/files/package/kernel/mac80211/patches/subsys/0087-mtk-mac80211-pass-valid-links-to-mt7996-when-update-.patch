From 1810dd8733a85a19bb86ff43199b4498d3e43fd3 Mon Sep 17 00:00:00 2001
From: Michael-CY Lee <michael-cy.lee@mediatek.com>
Date: Mon, 13 Jan 2025 15:13:17 +0800
Subject: [PATCH 087/128] mtk: mac80211: pass valid links to mt7996 when update
 vif's links in mac80211

MAC80211 used to pass active links to mt7996 when updating vif's links,
and mt7996 add/delete link according to the links provided by MAC80211.

However, we expect links being added/deleted only when valid links
changes, not active links.

This commits ass valid links to mt7996 when update vif's links in mac80211

Signed-off-by: Michael-CY Lee <michael-cy.lee@mediatek.com>
---
 net/mac80211/link.c | 18 ++++++++++++------
 1 file changed, 12 insertions(+), 6 deletions(-)

diff --git a/net/mac80211/link.c b/net/mac80211/link.c
index dba4df5f..f452914c 100644
--- a/net/mac80211/link.c
+++ b/net/mac80211/link.c
@@ -194,7 +194,6 @@ static int ieee80211_vif_update_links(struct ieee80211_sub_if_data *sdata,
 				      u16 new_links, u16 dormant_links)
 {
 	u16 old_links = sdata->vif.valid_links;
-	u16 old_active = sdata->vif.active_links;
 	unsigned long add = new_links & ~old_links;
 	unsigned long rem = old_links & ~new_links;
 	unsigned int link_id;
@@ -273,11 +272,18 @@ static int ieee80211_vif_update_links(struct ieee80211_sub_if_data *sdata,
 		ieee80211_set_vif_links_bitmaps(sdata, new_links, dormant_links);
 
 		/* tell the driver */
-		if (sdata->vif.type != NL80211_IFTYPE_AP_VLAN)
-			ret = drv_change_vif_links(sdata->local, sdata,
-						   old_links & old_active,
-						   new_links & sdata->vif.active_links,
-						   old);
+		// if (sdata->vif.type != NL80211_IFTYPE_AP_VLAN)
+		// 	ret = drv_change_vif_links(sdata->local, sdata,
+		// 				   old_links & old_active,
+		// 				   new_links & sdata->vif.active_links,
+		// 				   old);
+		/* FIXME
+		 * MLMR solution does link add/del when valid links change
+		 * and so we change to report old/new valid links to driver.
+		 * Also, TTLM is handled in other callbacks (not upstream yet).
+		 */
+		ret = drv_change_vif_links(sdata->local, sdata, old_links,
+					   new_links, old);
 		if (!new_links)
 			ieee80211_debugfs_recreate_netdev(sdata, false);
 	}
-- 
2.45.2

