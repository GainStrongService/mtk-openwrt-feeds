From ff0221a22f5a085094c7dc6ad5ec755fa7141e96 Mon Sep 17 00:00:00 2001
From: Michael-CY Lee <michael-cy.lee@mediatek.com>
Date: Tue, 10 Sep 2024 17:07:46 +0800
Subject: [PATCH 108/254] mtk: hostapd: remove sta_info from partner links when
 deauthenticating inactive STA

Originally only the sta_info of the associated hapd will be remove,
which might cause problem when STA triggers re-authentication.

This commit removes sta_info from parnter links when deauthenticating
inactive STA so that the STA is removed on a per-MLD basis.

Signed-off-by: Michael-CY Lee <michael-cy.lee@mediatek.com>
---
 src/ap/sta_info.c | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/src/ap/sta_info.c b/src/ap/sta_info.c
index 828ce7a3f..42ca7e45e 100644
--- a/src/ap/sta_info.c
+++ b/src/ap/sta_info.c
@@ -49,6 +49,7 @@ static void ap_sta_disassoc_cb_timeout(void *eloop_ctx, void *timeout_ctx);
 static void ap_sa_query_timer(void *eloop_ctx, void *timeout_ctx);
 static int ap_sta_remove(struct hostapd_data *hapd, struct sta_info *sta);
 static void ap_sta_delayed_1x_auth_fail_cb(void *eloop_ctx, void *timeout_ctx);
+static void ap_sta_remove_link_sta(struct hostapd_data *hapd, struct sta_info *sta);
 
 int ap_for_each_sta(struct hostapd_data *hapd,
 		    int (*cb)(struct hostapd_data *hapd, struct sta_info *sta,
@@ -590,6 +591,8 @@ void ap_handle_timer(void *eloop_ctx, void *timeout_ctx)
 			       HOSTAPD_LEVEL_INFO, "deauthenticated due to "
 			       "local deauth request");
 		hostapd_ubus_notify(hapd, "local-deauth", sta->addr);
+		if (ap_sta_is_mld(hapd, sta))
+			ap_sta_remove_link_sta(hapd, sta);
 		ap_free_sta(hapd, sta);
 		return;
 	}
@@ -759,6 +762,8 @@ skip_poll:
 			hapd, sta,
 			WLAN_REASON_PREV_AUTH_NOT_VALID);
 		hostapd_ubus_notify(hapd, "inactive-deauth", sta->addr);
+		if (ap_sta_is_mld(hapd, sta))
+			ap_sta_remove_link_sta(hapd, sta);
 		ap_free_sta(hapd, sta);
 		break;
 	}
-- 
2.45.2

