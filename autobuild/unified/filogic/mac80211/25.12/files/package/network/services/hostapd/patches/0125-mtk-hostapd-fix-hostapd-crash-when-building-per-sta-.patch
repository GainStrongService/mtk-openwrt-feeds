From 912ddcb8aeea12ba42f01d357a25c5b981b36d5f Mon Sep 17 00:00:00 2001
From: Peter Chiu <chui-hao.chiu@mediatek.com>
Date: Thu, 2 Jan 2025 15:26:29 +0800
Subject: [PATCH 125/254] mtk: hostapd: fix hostapd crash when building per-sta
 profile

Do not build the profile for links who are not ready.
If a link is not ready, hostapd will crash because hapd->iface->current_mode
is null in hostapd_eid_ht_operation.

Signed-off-by: Peter Chiu <chui-hao.chiu@mediatek.com>
---
 src/ap/beacon.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/src/ap/beacon.c b/src/ap/beacon.c
index a0cc8a9fa..7c8b826df 100644
--- a/src/ap/beacon.c
+++ b/src/ap/beacon.c
@@ -3417,6 +3417,8 @@ int ieee802_11_set_beacon(struct hostapd_data *hapd)
 
 	/* Generate per STA profiles for each affiliated APs */
 	for_each_mld_link(link_bss, hapd) {
+		if (!link_bss->started)
+			continue;
 		hostapd_gen_per_sta_profiles(link_bss);
 
 		if (link_bss->eht_mld_bss_critical_update == BSS_CRIT_UPDATE_FLAG &&
-- 
2.45.2

