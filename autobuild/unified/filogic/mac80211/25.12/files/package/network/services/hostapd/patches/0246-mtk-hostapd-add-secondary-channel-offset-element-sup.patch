From 6bcd70f02d6716950b2d902f1c5ffc6d0d3e03ae Mon Sep 17 00:00:00 2001
From: StanleyYP Wang <StanleyYP.Wang@mediatek.com>
Date: Mon, 1 Dec 2025 15:27:30 +0800
Subject: [PATCH 246/254] mtk: hostapd: add secondary channel offset element
 support

Add secondary channel offset IE during channel switch

Signed-off-by: StanleyYP Wang <StanleyYP.Wang@mediatek.com>
---
 src/ap/beacon.c | 28 ++++++++++++++++++++++++++++
 1 file changed, 28 insertions(+)

diff --git a/src/ap/beacon.c b/src/ap/beacon.c
index 31ba171ad..257cbaa6f 100644
--- a/src/ap/beacon.c
+++ b/src/ap/beacon.c
@@ -495,6 +495,25 @@ static u8 * hostapd_eid_csa(struct hostapd_data *hapd, u8 *eid)
 }
 
 
+static u8 * hostapd_eid_sec_chan_offs(struct hostapd_data *hapd, u8 *eid)
+{
+#define SEC_CHAN_OFFS_BELOW	0x3
+	int sec;
+
+	if (!hapd->iconf->ieee80211n || hapd->conf->disable_11n ||
+	    is_6ghz_op_class(hapd->iconf->op_class) ||
+	    !hapd->cs_freq_params.channel)
+		return eid;
+
+	sec = hapd->cs_freq_params.sec_channel_offset;
+	*eid++ = WLAN_EID_SECONDARY_CHANNEL_OFFSET;
+	*eid++ = 1;
+	*eid++ = sec < 0 ? SEC_CHAN_OFFS_BELOW : sec;
+
+	return eid;
+}
+
+
 static u8 * hostapd_eid_ecsa(struct hostapd_data *hapd, u8 *eid)
 {
 	if (!hapd->cs_freq_params.channel || !hapd->iface->cs_oper_class)
@@ -854,6 +873,9 @@ static u8 * hostapd_probe_resp_fill_elems(struct hostapd_data *hapd,
 		params->csa_pos = NULL;
 	pos = csa_pos;
 
+	/* Secondary channel offset IE */
+	pos = hostapd_eid_sec_chan_offs(hapd, pos);
+
 	/* ERP Information element */
 	pos = hostapd_eid_erp_info(hapd, pos);
 
@@ -2244,6 +2266,9 @@ static void hostapd_fill_bcn_sta_profile(struct hostapd_data *hapd,
 			link->sta_prof_csa_offset = csa_pos - 1 - buf;
 		epos = csa_pos;
 
+		/* Secondary channel offset IE */
+		epos = hostapd_eid_sec_chan_offs(h, epos);
+
 		/* eCSA IE */
 		csa_pos = hostapd_eid_ecsa(h, epos);
 		if (csa_pos != epos)
@@ -2417,6 +2442,9 @@ int ieee802_11_build_ap_params(struct hostapd_data *hapd,
 		hapd->cs_c_off_beacon = csa_pos - tail - 1;
 	tailpos = csa_pos;
 
+	/* Secondary channel offset IE */
+	tailpos = hostapd_eid_sec_chan_offs(hapd, tailpos);
+
 	/* ERP Information element */
 	tailpos = hostapd_eid_erp_info(hapd, tailpos);
 
-- 
2.45.2

