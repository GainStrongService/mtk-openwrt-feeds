From 947b1332acb3cb3994c11bf486576c4bf47ade46 Mon Sep 17 00:00:00 2001
From: Michael-CY Lee <michael-cy.lee@mediatek.com>
Date: Mon, 7 Jul 2025 08:47:17 +0800
Subject: [PATCH 191/254] mtk: wpa_s: add support to disable Radio Resource
 Management (RRM)

Signed-off-by: Michael-CY Lee <michael-cy.lee@mediatek.com>
---
 wpa_supplicant/config.c      | 1 +
 wpa_supplicant/config.h      | 9 +++++++++
 wpa_supplicant/config_file.c | 2 ++
 wpa_supplicant/sme.c         | 5 +++++
 4 files changed, 17 insertions(+)

diff --git a/wpa_supplicant/config.c b/wpa_supplicant/config.c
index 6ed4930d6..d39e4a3fc 100644
--- a/wpa_supplicant/config.c
+++ b/wpa_supplicant/config.c
@@ -5785,6 +5785,7 @@ static const struct global_parse_data global_fields[] = {
 	{ INT_RANGE(disable_btm, 0, 1), CFG_CHANGED_DISABLE_BTM },
 	{ INT_RANGE(extended_key_id, 0, 1), 0 },
 #endif /* CONFIG_WNM */
+	{ INT_RANGE(disable_rrm, 0, 1), 0 },
 	{ INT_RANGE(wowlan_disconnect_on_deinit, 0, 1), 0},
 	{ INT_RANGE(rsn_overriding, 0, 2), 0},
 #ifdef CONFIG_PASN
diff --git a/wpa_supplicant/config.h b/wpa_supplicant/config.h
index c187d36ed..aae5ce4fe 100644
--- a/wpa_supplicant/config.h
+++ b/wpa_supplicant/config.h
@@ -1792,6 +1792,15 @@ struct wpa_config {
 	 */
 	int disable_btm;
 
+	/**
+	 * disable_rrm - Disable Radio Resource Management (RRM) in STA
+	 * - Set to 0 to enable RRM
+	 * - Set to 1 to disable RRM
+	 *
+	 * By default RRM is enabled
+	 */
+	int disable_rrm;
+
 	/**
 	 * extended_key_id - Extended Key ID support
 	 *
diff --git a/wpa_supplicant/config_file.c b/wpa_supplicant/config_file.c
index 9baf5739c..376f55904 100644
--- a/wpa_supplicant/config_file.c
+++ b/wpa_supplicant/config_file.c
@@ -1731,6 +1731,8 @@ static void wpa_config_write_global(FILE *f, struct wpa_config *config)
 			config->p2p_interface_random_mac_addr);
 	if (config->disable_btm)
 		fprintf(f, "disable_btm=1\n");
+	if (config->disable_rrm)
+		fprintf(f, "disable_rrm=1\n");
 	if (config->extended_key_id != DEFAULT_EXTENDED_KEY_ID)
 		fprintf(f, "extended_key_id=%d\n",
 			config->extended_key_id);
diff --git a/wpa_supplicant/sme.c b/wpa_supplicant/sme.c
index 4f80f531d..a366abe41 100644
--- a/wpa_supplicant/sme.c
+++ b/wpa_supplicant/sme.c
@@ -344,6 +344,11 @@ static void sme_auth_handle_rrm(struct wpa_supplicant *wpa_s,
 		   "RRM: Determining whether RRM can be used - device support: 0x%x",
 		   wpa_s->drv_rrm_flags);
 
+	if (wpa_s->conf->disable_rrm) {
+		wpa_printf(MSG_DEBUG, "RRM: Disabled by configuration");
+		return;
+	}
+
 	rrm_ie = wpa_bss_get_ie(bss, WLAN_EID_RRM_ENABLED_CAPABILITIES);
 	if (!rrm_ie || !(bss->caps & IEEE80211_CAP_RRM)) {
 		wpa_printf(MSG_DEBUG, "RRM: No RRM in network");
-- 
2.45.2

