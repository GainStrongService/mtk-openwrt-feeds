From 85cc10e951769f7a6fbe9d8890af7c54a5d94688 Mon Sep 17 00:00:00 2001
From: Howard Hsu <howard-yh.hsu@mediatek.com>
Date: Mon, 23 Jun 2025 17:12:39 +0800
Subject: [PATCH 189/254] mtk: hostapd: support handle mtk_vendor element

For mtk eco-system feature, the ap needs to first identify whether the
peer station is an MTK station. The MTK station indicates itself by
including and MTK vendor element in its assoc req. Therefore, the ap
needs to recognize the MTK vendor IE and inform the mac80211 layer that
the peer station is an MTK station.

Signed-off-by: Howard Hsu <howard-yh.hsu@mediatek.com>
---
 src/ap/ap_drv_ops.c            |  3 ++-
 src/ap/ap_drv_ops.h            |  2 +-
 src/ap/apup.c                  |  4 ++--
 src/ap/ieee802_11.c            | 15 +++++++++++++--
 src/ap/sta_info.c              |  2 +-
 src/ap/sta_info.h              |  1 +
 src/common/ieee802_11_common.c | 17 +++++++++++++++++
 src/common/ieee802_11_common.h |  2 ++
 src/common/mtk_vendor.h        |  5 +++++
 src/drivers/driver.h           |  1 +
 src/drivers/driver_nl80211.c   |  7 +++++++
 11 files changed, 52 insertions(+), 7 deletions(-)

diff --git a/src/ap/ap_drv_ops.c b/src/ap/ap_drv_ops.c
index e2e085cae..080ee5590 100644
--- a/src/ap/ap_drv_ops.c
+++ b/src/ap/ap_drv_ops.c
@@ -508,7 +508,7 @@ int hostapd_sta_add(struct hostapd_data *hapd,
 		    const struct ieee80211_he_6ghz_band_cap *he_6ghz_capab,
 		    u32 flags, u8 qosinfo, u8 vht_opmode, int supp_p2p_ps,
 		    int set, const u8 *link_addr, bool mld_link_sta,
-		    u16 eml_cap)
+		    u16 eml_cap, bool mtk_sta)
 {
 	struct hostapd_sta_add_params params;
 
@@ -538,6 +538,7 @@ int hostapd_sta_add(struct hostapd_data *hapd,
 	params.support_p2p_ps = supp_p2p_ps;
 	params.set = set;
 	params.mld_link_id = -1;
+	params.mtk_sta = mtk_sta;
 
 #ifdef CONFIG_IEEE80211BE
 	/*
diff --git a/src/ap/ap_drv_ops.h b/src/ap/ap_drv_ops.h
index 76f3b7087..2fdd0683b 100644
--- a/src/ap/ap_drv_ops.h
+++ b/src/ap/ap_drv_ops.h
@@ -54,7 +54,7 @@ int hostapd_sta_add(struct hostapd_data *hapd,
 		    const struct ieee80211_he_6ghz_band_cap *he_6ghz_capab,
 		    u32 flags, u8 qosinfo, u8 vht_opmode, int supp_p2p_ps,
 		    int set, const u8 *link_addr, bool mld_link_sta,
-		    u16 eml_cap);
+		    u16 eml_cap, bool mtk_sta);
 int hostapd_set_privacy(struct hostapd_data *hapd, int enabled);
 int hostapd_set_generic_elem(struct hostapd_data *hapd, const u8 *elem,
 			     size_t elem_len);
diff --git a/src/ap/apup.c b/src/ap/apup.c
index b4155085a..9d859bdf7 100644
--- a/src/ap/apup.c
+++ b/src/ap/apup.c
@@ -68,7 +68,7 @@ void apup_process_beacon(struct hostapd_data *hapd,
 	            NULL, 0, 0, NULL, NULL, NULL, 0, NULL, 0, NULL,
 	            sta_ret->flags, 0, 0, 0,
 	            0, // 0 add, 1 set
-	            mld_link_addr, mld_link_sta, eml_cap);
+	            mld_link_addr, mld_link_sta, eml_cap, false);
 
 	sta_ret->flags |= WLAN_STA_AUTH;
 	wpa_auth_sm_event(sta_ret->wpa_sm, WPA_AUTH);
@@ -142,7 +142,7 @@ void apup_process_beacon(struct hostapd_data *hapd,
 	            sta_ret->vht_opmode,
 	            0, // int supp_p2p_ps
 	            1, // 0 add, 1 set
-	            mld_link_addr, mld_link_sta, eml_cap);
+	            mld_link_addr, mld_link_sta, eml_cap, false);
 
 	ap_sta_set_authorized(hapd, sta_ret, 1);
 	hostapd_set_sta_flags(hapd, sta_ret);
diff --git a/src/ap/ieee802_11.c b/src/ap/ieee802_11.c
index a557092d8..b013df6a8 100644
--- a/src/ap/ieee802_11.c
+++ b/src/ap/ieee802_11.c
@@ -3880,6 +3880,15 @@ static void check_mscs_desc_elem(struct hostapd_data *hapd, struct sta_info *sta
 	sta->mscs_assoc_included = 1;
 }
 
+static void check_mtk_vendor_elem(struct hostapd_data *hapd, struct sta_info *sta,
+				  struct ieee802_11_elems *elems)
+{
+	if (!sta || !elems->vendor_mtk)
+		return;
+
+	sta->mtk_sta = 1;
+}
+
 static u16 check_multi_ap(struct hostapd_data *hapd, struct sta_info *sta,
 			  const u8 *multi_ap_ie, size_t multi_ap_len)
 {
@@ -4499,6 +4508,7 @@ static int __check_assoc_ies(struct hostapd_data *hapd, struct sta_info *sta,
 		}
 	}
 #endif /* CONFIG_IEEE80211BE */
+	check_mtk_vendor_elem(hapd, sta, elems);
 
 #ifdef CONFIG_P2P
 	if (elems->p2p && ies && ies_len) {
@@ -5407,7 +5417,7 @@ static int add_associated_sta(struct hostapd_data *hapd,
 			    sta->he_6ghz_capab,
 			    sta->flags | WLAN_STA_ASSOC, sta->qosinfo,
 			    sta->vht_opmode, sta->p2p_ie ? 1 : 0,
-			    set, mld_link_addr, mld_link_sta, eml_cap)) {
+			    set, mld_link_addr, mld_link_sta, eml_cap, sta->mtk_sta)) {
 		hostapd_logger(hapd, sta->addr,
 			       HOSTAPD_MODULE_IEEE80211, HOSTAPD_LEVEL_NOTICE,
 			       "Could not %s STA to kernel driver",
@@ -6119,7 +6129,8 @@ static void handle_assoc(struct hostapd_data *hapd,
 					    0, NULL, NULL, NULL, 0, NULL, 0, NULL,
 					    sta->flags, 0, 0, 0, 0,
 					    sta->setup_link_addr, false,
-					    sta->mld_info.common_info.eml_capa)) {
+					    sta->mld_info.common_info.eml_capa,
+					    sta->mtk_sta)) {
 				resp = WLAN_STATUS_UNSPECIFIED_FAILURE;
 				goto fail;
 			}
diff --git a/src/ap/sta_info.c b/src/ap/sta_info.c
index ab98ed985..dc2979232 100644
--- a/src/ap/sta_info.c
+++ b/src/ap/sta_info.c
@@ -2053,7 +2053,7 @@ int ap_sta_re_add(struct hostapd_data *hapd, struct sta_info *sta)
 			    sta->supported_rates_len,
 			    0, NULL, NULL, NULL, 0, NULL, 0, NULL,
 			    sta->flags, 0, 0, 0, 0,
-			    mld_link_addr, mld_link_sta, eml_cap)) {
+			    mld_link_addr, mld_link_sta, eml_cap, sta->mtk_sta)) {
 		hostapd_logger(hapd, sta->addr,
 			       HOSTAPD_MODULE_IEEE80211,
 			       HOSTAPD_LEVEL_NOTICE,
diff --git a/src/ap/sta_info.h b/src/ap/sta_info.h
index 7de3bd93e..c05f91291 100644
--- a/src/ap/sta_info.h
+++ b/src/ap/sta_info.h
@@ -339,6 +339,7 @@ struct sta_info {
 			      * units of 1000 TUs */
 
 	u64 last_known_sta_id_timestamp;
+	bool mtk_sta;
 };
 
 
diff --git a/src/common/ieee802_11_common.c b/src/common/ieee802_11_common.c
index 8c49a5ac8..814074891 100644
--- a/src/common/ieee802_11_common.c
+++ b/src/common/ieee802_11_common.c
@@ -15,6 +15,7 @@
 #include "qca-vendor.h"
 #include "ieee802_11_defs.h"
 #include "ieee802_11_common.h"
+#include "mtk_vendor.h"
 
 
 static int ieee802_11_parse_vendor_specific(const u8 *pos, size_t elen,
@@ -212,6 +213,22 @@ static int ieee802_11_parse_vendor_specific(const u8 *pos, size_t elen,
 		}
 		break;
 
+	case OUI_MTK:
+		switch (pos[3]) {
+		case MTK_VENDOR_ELEM_DEFAULT:
+		case MTK_VENDOR_ELEM_256QAM:
+			elems->vendor_mtk = pos;
+			elems->vendor_mtk_len = elen;
+			break;
+		default:
+			wpa_printf(MSG_EXCESSIVE, "Unknown Mediatek "
+				   "information element ignored "
+				   "(type=%d len=%lu)",
+				   pos[3], (unsigned long) elen);
+			return -1;
+		}
+		break;
+
 	default:
 		wpa_printf(MSG_EXCESSIVE, "unknown vendor specific "
 			   "information element ignored (vendor OUI "
diff --git a/src/common/ieee802_11_common.h b/src/common/ieee802_11_common.h
index adca0bce8..49f28b341 100644
--- a/src/common/ieee802_11_common.h
+++ b/src/common/ieee802_11_common.h
@@ -124,6 +124,7 @@ struct ieee802_11_elems {
 	const u8 *rsn_selection;
 	const u8 *wfa_capab;
 	const u8 *mscs_desc;
+	const u8 *vendor_mtk;
 
 	u8 ssid_len;
 	u8 supp_rates_len;
@@ -196,6 +197,7 @@ struct ieee802_11_elems {
 	size_t rsn_selection_len;
 	u8 wfa_capab_len;
 	size_t mscs_desc_len;
+	size_t vendor_mtk_len;
 
 	struct mb_ies_info mb_ies;
 
diff --git a/src/common/mtk_vendor.h b/src/common/mtk_vendor.h
index fa285e82a..0d2325c56 100644
--- a/src/common/mtk_vendor.h
+++ b/src/common/mtk_vendor.h
@@ -26,6 +26,11 @@ enum mtk_nl80211_vendor_subcmds {
 	MTK_NL80211_VENDOR_SUBCMD_DFS_TX_CTRL = 0xd5,
 };
 
+enum mtk_vendor_element_id {
+	MTK_VENDOR_ELEM_DEFAULT = 0,
+	MTK_VENDOR_ELEM_256QAM = 8,
+};
+
 enum mtk_nl80211_vendor_subevents {
 	MTK_NL80211_VENDOR_EVENT_PP_BMP_UPDATE = 0x5,
 };
diff --git a/src/drivers/driver.h b/src/drivers/driver.h
index e2ac4f0ff..b85bbedfb 100644
--- a/src/drivers/driver.h
+++ b/src/drivers/driver.h
@@ -2708,6 +2708,7 @@ struct hostapd_sta_add_params {
 	s8 mld_link_id;
 	const u8 *mld_link_addr;
 	u16 eml_cap;
+	bool mtk_sta;
 };
 
 struct mac_address {
diff --git a/src/drivers/driver_nl80211.c b/src/drivers/driver_nl80211.c
index 05686d54d..f45bae9a9 100644
--- a/src/drivers/driver_nl80211.c
+++ b/src/drivers/driver_nl80211.c
@@ -6083,6 +6083,13 @@ static int wpa_driver_nl80211_sta_add(void *priv,
 				goto fail;
 		}
 
+		if (params->mtk_sta) {
+			wpa_printf(MSG_DEBUG, "  * mtk_sta =%u",
+				   params->mtk_sta);
+			if (nla_put_flag(msg, NL80211_ATTR_VENDOR_MTK_STA))
+				goto fail;
+		}
+
 		if (is_ap_interface(drv->nlmode) &&
 		    nla_put_u8(msg, NL80211_ATTR_STA_SUPPORT_P2P_PS,
 			       params->support_p2p_ps ?
-- 
2.45.2

