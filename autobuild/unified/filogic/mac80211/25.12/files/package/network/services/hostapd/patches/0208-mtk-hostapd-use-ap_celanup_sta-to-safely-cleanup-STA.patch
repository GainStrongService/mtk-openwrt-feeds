From 164898d082b87c997fd028426d80112d69d59383 Mon Sep 17 00:00:00 2001
From: Michael-CY Lee <michael-cy.lee@mediatek.com>
Date: Wed, 20 Aug 2025 17:01:20 +0800
Subject: [PATCH 208/254] mtk: hostapd: use ap_celanup_sta() to safely cleanup
 STA when receive AUTH from associated STA

The original function hostapd_ml_handle_disconnect() requires that
sta_info from the setup link exists; otherwise, it might cause
hostapd to crash.

The function ap_cleanup_sta() can safely handle such cases.

Signed-off-by: Michael-CY Lee <michael-cy.lee@mediatek.com>
---
 src/ap/ieee802_11.c | 2 +-
 src/ap/sta_info.c   | 2 +-
 src/ap/sta_info.h   | 2 +-
 3 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/src/ap/ieee802_11.c b/src/ap/ieee802_11.c
index 9806f7347..d85ef0184 100644
--- a/src/ap/ieee802_11.c
+++ b/src/ap/ieee802_11.c
@@ -3495,7 +3495,7 @@ static void handle_auth(struct hostapd_data *hapd,
 				   "receive AUTH from associated STA "MACSTR
 				   ", do deauthentication\n",
 				   MAC2STR(sa));
-			hostapd_ml_handle_disconnect(hapd, sta, mgmt, false);
+			ap_cleanup_sta(hapd, sa);
 			hostapd_drv_sta_remove(hapd, sa);
 			resp = WLAN_STATUS_UNSPECIFIED_FAILURE;
 			sta = NULL;
diff --git a/src/ap/sta_info.c b/src/ap/sta_info.c
index 4fb78523f..acd3b8748 100644
--- a/src/ap/sta_info.c
+++ b/src/ap/sta_info.c
@@ -2107,7 +2107,7 @@ bool ap_sta_in_list(struct hostapd_data *hapd, struct sta_info *sta) {
 	return false;
 }
 
-void ap_cleanup_sta(struct hostapd_data *hapd, u8 *addr) {
+void ap_cleanup_sta(struct hostapd_data *hapd, const u8 *addr) {
 	struct hostapd_data *h;
 	struct sta_info *sta;
 
diff --git a/src/ap/sta_info.h b/src/ap/sta_info.h
index 0af8d4670..edbdbfc50 100644
--- a/src/ap/sta_info.h
+++ b/src/ap/sta_info.h
@@ -442,6 +442,6 @@ void hostapd_free_link_stas(struct hostapd_data *hapd);
 void clear_wpa_sm_for_each_partner_link(struct hostapd_data *hapd,
 					struct sta_info *psta);
 bool ap_sta_in_list(struct hostapd_data *hapd, struct sta_info *sta);
-void ap_cleanup_sta(struct hostapd_data *hapd, u8 *addr);
+void ap_cleanup_sta(struct hostapd_data *hapd, const u8 *addr);
 
 #endif /* STA_INFO_H */
-- 
2.45.2

