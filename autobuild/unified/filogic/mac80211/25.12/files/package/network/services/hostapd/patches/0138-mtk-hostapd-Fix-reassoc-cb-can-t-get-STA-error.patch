From ba7e94b9b3dd3cd4912caebea759833118bd4265 Mon Sep 17 00:00:00 2001
From: Allen Ye <allen.ye@mediatek.com>
Date: Thu, 16 Jan 2025 15:52:20 +0800
Subject: [PATCH 138/254] mtk: hostapd: Fix reassoc cb can't get STA error

Change mld reassoc resp frame sa to use mld address when the connection
is mlo.

Once MLD AP receive a non AP mld reassoc frame, kernel may not tanslate
the sa and da to mld address due to there is no recorded corresponding
STA entry. That makes mgmt->sa indicates a link address, which makes
handle_assoc_cb() can't find a related STA.

Remove unuse variable, mld_addrs_not_translated, which is added in commit,
e99670420 and the original logic is removed by commit, fd1a35e14.

Signed-off-by: Allen Ye <allen.ye@mediatek.com>
---
 src/ap/ieee802_11.c | 10 +++-------
 1 file changed, 3 insertions(+), 7 deletions(-)

diff --git a/src/ap/ieee802_11.c b/src/ap/ieee802_11.c
index 3f60f9f53..3dc87e11d 100644
--- a/src/ap/ieee802_11.c
+++ b/src/ap/ieee802_11.c
@@ -5858,7 +5858,6 @@ static void handle_assoc(struct hostapd_data *hapd,
 #endif /* CONFIG_FILS */
 	int omit_rsnxe = 0;
 	bool set_beacon = false;
-	bool mld_addrs_not_translated = false;
 	bool sae_pk = false;
 
 	if (len < IEEE80211_HDRLEN + (reassoc ? sizeof(mgmt->u.reassoc_req) :
@@ -5935,7 +5934,6 @@ static void handle_assoc(struct hostapd_data *hapd,
 				wpa_printf(MSG_DEBUG,
 					   "MLD: Switching to assoc hapd/station");
 				hapd = assoc_hapd;
-				mld_addrs_not_translated = true;
 			}
 
 			/* Allow link address to be changed if an SA query
@@ -5946,7 +5944,6 @@ static void handle_assoc(struct hostapd_data *hapd,
 				os_memcpy(sta->mld_info.links[_link].peer_addr,
 					  mgmt->sa, ETH_ALEN);
 			}
-
 		}
 	}
 #endif /* CONFIG_IEEE80211BE */
@@ -6332,10 +6329,9 @@ static void handle_assoc(struct hostapd_data *hapd,
 
 	if (resp >= 0)
 		reply_res = send_assoc_resp(hapd,
-					    mld_addrs_not_translated ?
-					    NULL : sta,
-					    mgmt->sa, resp, reassoc,
-					    pos, left, rssi, omit_rsnxe);
+					    sta, sta ? sta->addr : mgmt->sa,
+					    resp, reassoc, pos, left, rssi,
+					    omit_rsnxe);
 	os_free(tmp);
 
 	/*
-- 
2.45.2

