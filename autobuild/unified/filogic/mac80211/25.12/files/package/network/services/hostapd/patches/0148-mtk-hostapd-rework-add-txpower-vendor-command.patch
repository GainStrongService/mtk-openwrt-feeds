From fdc921988681625cbfe9e9a40f5ecda5605d5827 Mon Sep 17 00:00:00 2001
From: Allen Ye <allen.ye@mediatek.com>
Date: Mon, 3 Mar 2025 15:37:19 +0800
Subject: [PATCH 148/254] mtk: hostapd: rework add txpower vendor command

Set default sku index as -1 and hostapd won't bring sku index, if
the config didn't specify the index larger than 0.

The meaning of sku index is the same as usually, 0 is don't specify
the index, larger than 0 indicates driver need to match the
corresponding index in dts.

Signed-off-by: Allen Ye <allen.ye@mediatek.com>
---
 src/ap/ap_config.c           | 4 ++--
 src/ap/ap_config.h           | 4 ++--
 src/ap/ap_drv_ops.c          | 2 +-
 src/drivers/driver_nl80211.c | 3 ++-
 4 files changed, 7 insertions(+), 6 deletions(-)

diff --git a/src/ap/ap_config.c b/src/ap/ap_config.c
index 968f9b723..68885ef9d 100644
--- a/src/ap/ap_config.c
+++ b/src/ap/ap_config.c
@@ -325,8 +325,8 @@ struct hostapd_config * hostapd_config_defaults(void)
 	conf->pp_mode = PP_FW_MODE;
 
 	conf->lpi_psd = 0;
-	conf->sku_idx = 0;
-	conf->lpi_sku_idx = 0;
+	conf->sku_idx = -1;
+	conf->lpi_sku_idx = -1;
 	conf->lpi_bcn_enhance = 0;
 
 	hostapd_set_and_check_bw320_offset(conf, 0);
diff --git a/src/ap/ap_config.h b/src/ap/ap_config.h
index 966fb810e..ea49329cc 100644
--- a/src/ap/ap_config.h
+++ b/src/ap/ap_config.h
@@ -1359,8 +1359,8 @@ struct hostapd_config {
 	void *muru_config;
 	u8 pp_mode;
 	u8 lpi_psd;
-	u8 sku_idx;
-	u8 lpi_sku_idx;
+	s8 sku_idx;
+	s8 lpi_sku_idx;
 	u8 lpi_bcn_enhance;
 };
 
diff --git a/src/ap/ap_drv_ops.c b/src/ap/ap_drv_ops.c
index fa4b8447a..06a8bf4b1 100644
--- a/src/ap/ap_drv_ops.c
+++ b/src/ap/ap_drv_ops.c
@@ -1662,7 +1662,7 @@ int hostapd_drv_txpower_ctrl(struct hostapd_data *hapd)
 			goto out;
 	}
 
-	if (hapd->iface->afc.lpi_mode == true)
+	if (hapd->iface->afc.lpi_mode == true && hapd->iconf->lpi_sku_idx > -1)
 		sku_idx = hapd->iconf->lpi_sku_idx;
 #endif /* CONFIG_AFC */
 
diff --git a/src/drivers/driver_nl80211.c b/src/drivers/driver_nl80211.c
index 4f83d173c..4638ea9d2 100644
--- a/src/drivers/driver_nl80211.c
+++ b/src/drivers/driver_nl80211.c
@@ -16861,7 +16861,8 @@ static int nl80211_txpower_ctrl(void *priv, u8 lpi_psd, s8 sku_idx, u8 lpi_bcn_e
 		goto fail;
 
 	nla_put_u8(msg, MTK_VENDOR_ATTR_TXPOWER_CTRL_LPI_PSD, lpi_psd);
-	nla_put_u8(msg, MTK_VENDOR_ATTR_TXPOWER_CTRL_SKU_IDX, sku_idx);
+	if (sku_idx > -1)
+		nla_put_u8(msg, MTK_VENDOR_ATTR_TXPOWER_CTRL_SKU_IDX, sku_idx);
 	nla_put_u8(msg, MTK_VENDOR_ATTR_TXPOWER_CTRL_LPI_BCN_ENHANCE, lpi_bcn_enhance);
 
 	if (link_id > -1)
-- 
2.45.2

