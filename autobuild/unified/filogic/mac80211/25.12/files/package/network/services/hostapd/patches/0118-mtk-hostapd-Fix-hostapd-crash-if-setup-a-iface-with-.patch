From 503c632307b441efa9a2792f3e4bc135bedca62b Mon Sep 17 00:00:00 2001
From: Michael-CY Lee <michael-cy.lee@mediatek.com>
Date: Fri, 8 Nov 2024 10:20:03 +0800
Subject: [PATCH 118/254] mtk: hostapd: Fix hostapd crash if setup a iface with
 a link bss failed

The crash occurs while some link bsses is traversing all the links by using
for_each_mld_link(), and hostapd access to the link bss which is already
been freed.

If hostapd setup a link bss failed, the link should be removed from
its hostapd_mld. However, the function hostapd_bss_link_deinit
doesn't remove the link bss correctly if it is the first bss and
hapd->drv_priv is null. Therefore we should refator the remove iface flow
as hostapd_remove_iface (used in wifi down cmd).

There are some cases that setup a bss may fail (e.g. afc query failed) or
trigger channel switch while hostapd is setting up other links.
The failed link would be add into hostapd_mld while driver_init().

Signed-off-by: Allen Ye <allen.ye@mediatek.com>
Signed-off-by: Michael-CY Lee <michael-cy.lee@mediatek.com>
---
 src/ap/hostapd.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/src/ap/hostapd.c b/src/ap/hostapd.c
index 70670d882..417a634e9 100644
--- a/src/ap/hostapd.c
+++ b/src/ap/hostapd.c
@@ -5704,6 +5704,9 @@ int hostapd_mld_remove_link(struct hostapd_data *hapd)
 	if (!hapd->link.next)
 		return 0;
 
+	if (!(mld->active_links & BIT(hapd->mld_link_id)))
+		return 0;
+
 	dl_list_del(&hapd->link);
 	mld->num_links--;
 	mld->active_links &= ~BIT(hapd->mld_link_id);
-- 
2.45.2

