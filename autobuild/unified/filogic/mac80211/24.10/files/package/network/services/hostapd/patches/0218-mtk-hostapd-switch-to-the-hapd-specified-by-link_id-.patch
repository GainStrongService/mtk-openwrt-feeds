From 7eac4acae83981b68d54e48f9f2f475b3c1dc7ff Mon Sep 17 00:00:00 2001
From: Michael-CY Lee <michael-cy.lee@mediatek.com>
Date: Thu, 17 Jul 2025 10:23:23 +0800
Subject: [PATCH 218/236] mtk: hostapd: switch to the hapd specified by link_id
 when receiving spurious frame

Signed-off-by: Michael-CY Lee <michael-cy.lee@mediatek.com>
---
 src/ap/drv_callbacks.c             | 1 +
 src/drivers/driver.h               | 1 +
 src/drivers/driver_nl80211_event.c | 2 ++
 3 files changed, 4 insertions(+)

diff --git a/src/ap/drv_callbacks.c b/src/ap/drv_callbacks.c
index 20205e730..5f367ef51 100644
--- a/src/ap/drv_callbacks.c
+++ b/src/ap/drv_callbacks.c
@@ -2900,6 +2900,7 @@ void hostapd_wpa_event(void *ctx, enum wpa_event_type event,
 		hostapd_client_poll_ok(hapd, data->client_poll.addr);
 		break;
 	case EVENT_RX_FROM_UNKNOWN:
+		hapd = switch_link_hapd(hapd, data->rx_from_unknown.link_id);
 		hostapd_rx_from_unknown_sta(hapd, data->rx_from_unknown.bssid,
 					    data->rx_from_unknown.addr,
 					    data->rx_from_unknown.wds);
diff --git a/src/drivers/driver.h b/src/drivers/driver.h
index 11eeb0786..64839e6f0 100644
--- a/src/drivers/driver.h
+++ b/src/drivers/driver.h
@@ -6999,6 +6999,7 @@ union wpa_event_data {
 		const u8 *bssid;
 		const u8 *addr;
 		int wds;
+		int link_id;
 	} rx_from_unknown;
 
 	/**
diff --git a/src/drivers/driver_nl80211_event.c b/src/drivers/driver_nl80211_event.c
index 85a53b378..bfdb288a9 100644
--- a/src/drivers/driver_nl80211_event.c
+++ b/src/drivers/driver_nl80211_event.c
@@ -2880,6 +2880,8 @@ static void nl80211_spurious_frame(struct i802_bss *bss, struct nlattr **tb,
 	event.rx_from_unknown.bssid = bss->addr;
 	event.rx_from_unknown.addr = nla_data(tb[NL80211_ATTR_MAC]);
 	event.rx_from_unknown.wds = wds;
+	event.rx_from_unknown.link_id = tb[NL80211_ATTR_MLO_LINK_ID] ?
+				nla_get_u8(tb[NL80211_ATTR_MLO_LINK_ID]) : -1;
 
 	wpa_supplicant_event(bss->ctx, EVENT_RX_FROM_UNKNOWN, &event);
 }
-- 
2.45.2

