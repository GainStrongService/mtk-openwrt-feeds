From 2f323197b27f9d0367dbe75c28515569d79e3b09 Mon Sep 17 00:00:00 2001
From: Howard Hsu <howard-yh.hsu@mediatek.com>
Date: Thu, 13 Feb 2025 17:46:26 +0800
Subject: [PATCH 163/236] mtk: hostapd: add new argument mbo_cert for
 hostapd_cli bss_tm_req

Add a new argument "mbo_cert" for hostapd_cli bss_tm_req to bypass the
commit 7a873c8.

Commit 7a873c8 does not set a timer for disassoc frames for MLD STAs,
while the certification EHT program 4.2.5.6 requires sending dissassoc
frames after the BTM request. Thus, we use "mbo_cert" to bypass commit
7a873c8 for test case 4.2.5.6.

Note that this commit is a workaround for EHT prgram 4.2.5.6.

Signed-off-by: Howard Hsu <howard-yh.hsu@mediatek.com>

---
 src/ap/ctrl_iface_ap.c | 2 +-
 src/ap/ubus.c          | 3 ++-
 2 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/src/ap/ctrl_iface_ap.c b/src/ap/ctrl_iface_ap.c
index e53027bde..d315eeba7 100644
--- a/src/ap/ctrl_iface_ap.c
+++ b/src/ap/ctrl_iface_ap.c
@@ -1561,7 +1561,7 @@ int hostapd_ctrl_iface_bss_tm_req(struct hostapd_data *hapd,
 	ret = wnm_send_bss_tm_req(hapd, sta, req_mode, disassoc_timer,
 				  valid_int, bss_term_dur, dialog_token, url,
 				  nei_len ? nei_rep : NULL, nei_len,
-				  mbo_len ? mbo : NULL, mbo_len);
+				  mbo_len ? mbo : NULL, mbo_len, mbo_cert);
 #ifdef CONFIG_MBO
 fail:
 #endif /* CONFIG_MBO */
diff --git a/src/ap/ubus.c b/src/ap/ubus.c
index 225672075..c5b6aa8e3 100644
--- a/src/ap/ubus.c
+++ b/src/ap/ubus.c
@@ -1421,7 +1421,8 @@ hostapd_bss_tr_send(struct hostapd_data *hapd, u8 *addr, bool disassoc_imminent,
 #endif
 
 	if (wnm_send_bss_tm_req(hapd, sta, req_mode, disassoc_timer, validity_period, NULL,
-				dialog_token, NULL, nr, nr_len, mbo_len ? mbo : NULL, mbo_len))
+				dialog_token, NULL, nr, nr_len, mbo_len ? mbo : NULL, mbo_len,
+				false))
 		return UBUS_STATUS_UNKNOWN_ERROR;
 
 	return 0;
-- 
2.45.2

