From 4df4dbff027a001eb16ba3b2907aa2bc3cdd4632 Mon Sep 17 00:00:00 2001
From: Michael-CY Lee <michael-cy.lee@mediatek.com>
Date: Thu, 24 Jul 2025 11:09:28 +0800
Subject: [PATCH 226/236] mtk: hostapd: free link STA for user triggering
 deauthentication

Signed-off-by: Michael-CY Lee <michael-cy.lee@mediatek.com>
---
 src/ap/ctrl_iface_ap.c | 7 ++++++-
 src/ap/sta_info.c      | 8 +++-----
 src/ap/sta_info.h      | 1 +
 3 files changed, 10 insertions(+), 6 deletions(-)

diff --git a/src/ap/ctrl_iface_ap.c b/src/ap/ctrl_iface_ap.c
index 1222feae3..f9fb6f92c 100644
--- a/src/ap/ctrl_iface_ap.c
+++ b/src/ap/ctrl_iface_ap.c
@@ -701,8 +701,13 @@ int hostapd_ctrl_iface_deauthenticate(struct hostapd_data *hapd,
 	sta = ap_get_sta(hapd, addr);
 	if (os_strstr(txtaddr, " tx=0")) {
 		hostapd_drv_sta_remove(hapd, addr);
-		if (sta)
+		if (sta) {
+#ifdef CONFIG_IEEE80211BE
+			if (hostapd_is_mld_ap(hapd))
+				ap_sta_remove_link_sta(hapd, sta);
+#endif /* CONFIG_IEEE80211BE */
 			ap_free_sta(hapd, sta);
+		}
 	} else {
 		hostapd_drv_sta_deauth(hapd, addr, reason);
 		if (sta)
diff --git a/src/ap/sta_info.c b/src/ap/sta_info.c
index eb8f1bd21..014be4912 100644
--- a/src/ap/sta_info.c
+++ b/src/ap/sta_info.c
@@ -49,7 +49,6 @@ static void ap_sta_disassoc_cb_timeout(void *eloop_ctx, void *timeout_ctx);
 static void ap_sa_query_timer(void *eloop_ctx, void *timeout_ctx);
 static int ap_sta_remove(struct hostapd_data *hapd, struct sta_info *sta);
 static void ap_sta_delayed_1x_auth_fail_cb(void *eloop_ctx, void *timeout_ctx);
-static void ap_sta_remove_link_sta(struct hostapd_data *hapd, struct sta_info *sta);
 
 int ap_for_each_sta(struct hostapd_data *hapd,
 		    int (*cb)(struct hostapd_data *hapd, struct sta_info *sta,
@@ -1924,10 +1923,9 @@ int ap_sta_pending_delayed_1x_auth_fail_disconnect(struct hostapd_data *hapd,
 }
 
 
-#ifdef CONFIG_IEEE80211BE
-static void ap_sta_remove_link_sta(struct hostapd_data *hapd,
-				   struct sta_info *sta)
+void ap_sta_remove_link_sta(struct hostapd_data *hapd, struct sta_info *sta)
 {
+#ifdef CONFIG_IEEE80211BE
 	struct hostapd_data *tmp_hapd;
 
 	for_each_mld_link(tmp_hapd, hapd) {
@@ -1946,8 +1944,8 @@ static void ap_sta_remove_link_sta(struct hostapd_data *hapd,
 			break;
 		}
 	}
-}
 #endif /* CONFIG_IEEE80211BE */
+}
 
 
 int ap_sta_re_add(struct hostapd_data *hapd, struct sta_info *sta)
diff --git a/src/ap/sta_info.h b/src/ap/sta_info.h
index fa8fda629..92674ecb0 100644
--- a/src/ap/sta_info.h
+++ b/src/ap/sta_info.h
@@ -365,6 +365,7 @@ int ap_for_each_sta(struct hostapd_data *hapd,
 struct sta_info * ap_get_sta(struct hostapd_data *hapd, const u8 *sta);
 struct sta_info * ap_get_sta_p2p(struct hostapd_data *hapd, const u8 *addr);
 void ap_sta_hash_add(struct hostapd_data *hapd, struct sta_info *sta);
+void ap_sta_remove_link_sta(struct hostapd_data *hapd, struct sta_info *sta);
 void ap_free_sta(struct hostapd_data *hapd, struct sta_info *sta);
 void ap_sta_ip6addr_del(struct hostapd_data *hapd, struct sta_info *sta);
 void hostapd_free_stas(struct hostapd_data *hapd);
-- 
2.45.2

