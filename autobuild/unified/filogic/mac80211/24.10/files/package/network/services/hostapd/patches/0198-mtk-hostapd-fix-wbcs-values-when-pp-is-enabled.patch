From 0a4b27d95cfd79336e77dc8e434ab273d3f84de4 Mon Sep 17 00:00:00 2001
From: StanleyYP Wang <StanleyYP.Wang@mediatek.com>
Date: Mon, 5 May 2025 13:19:43 +0800
Subject: [PATCH 198/236] mtk: hostapd: fix wbcs values when pp is enabled

The seg0 and seg1 for punct_update_legacy_bw should be center ch &
center ch 2 instead of the value of seg0 & seg1 in wbcs.
They are different when bandwidth is 160, as wbcs seg0 will become primary
80MHz center and seg1 will become 160MHz center.

Signed-off-by: StanleyYP Wang <StanleyYP.Wang@mediatek.com>
---
 src/ap/ieee802_11.c | 52 +++++++++++++++++++++++++++++++++------------
 1 file changed, 38 insertions(+), 14 deletions(-)

diff --git a/src/ap/ieee802_11.c b/src/ap/ieee802_11.c
index 83fb824d8..7a65542fa 100644
--- a/src/ap/ieee802_11.c
+++ b/src/ap/ieee802_11.c
@@ -19,6 +19,7 @@
 #include "crypto/random.h"
 #include "common/ieee802_11_defs.h"
 #include "common/ieee802_11_common.h"
+#include "common/hw_features_common.h"
 #include "common/wpa_ctrl.h"
 #include "common/sae.h"
 #include "common/dpp.h"
@@ -7922,17 +7923,52 @@ u8 * hostapd_eid_txpower_envelope(struct hostapd_data *hapd, u8 *eid)
 static u8 * hostapd_eid_wb_channel_switch(struct hostapd_data *hapd, u8 *eid,
 					  u8 chan1, u8 chan2)
 {
+	int bandwidth = hapd->cs_freq_params.bandwidth;
 	u8 bw;
-	enum oper_chan_width oper_chwidth = CONF_OPER_CHWIDTH_160MHZ;
 #ifdef CONFIG_IEEE80211BE
 	u16 punct_bitmap = hapd->cs_freq_params.punct_bitmap;
+
+	if (punct_bitmap) {
+		enum oper_chan_width oper_chwidth;
+
+		switch (bandwidth) {
+		case 320:
+			oper_chwidth = CONF_OPER_CHWIDTH_320MHZ;
+			break;
+		case 160:
+			oper_chwidth = CONF_OPER_CHWIDTH_160MHZ;
+			break;
+		case 80:
+			oper_chwidth = CONF_OPER_CHWIDTH_80MHZ;
+			break;
+		default:
+			/* not valid punctured bitmap */
+			return eid;
+		}
+
+		punct_update_legacy_bw(punct_bitmap,
+				       hapd->cs_freq_params.channel,
+				       &oper_chwidth, &chan1, &chan2);
+		switch (oper_chwidth) {
+		case CONF_OPER_CHWIDTH_160MHZ:
+			bandwidth = 160;
+			break;
+		case CONF_OPER_CHWIDTH_80MHZ:
+			bandwidth = 80;
+			break;
+		case CONF_OPER_CHWIDTH_USE_HT:
+		default:
+			bandwidth = chan1 ? 40 : 20;
+			break;
+		}
+	}
 #endif /* CONFIG_IEEE80211BE */
 
 	/* bandwidth: 0: 40, 1: 80, 160, 80+80, 4 to 255 reserved as per
 	 * IEEE Std 802.11-2024, 9.4.2.156 and Table 9-316 (VHT Operation
 	 * Information subfields).
 	 */
-	switch (hapd->cs_freq_params.bandwidth) {
+	switch (bandwidth) {
 	case 320:
 		/* As per IEEE P802.11be/D7.0, 35.15.3,
 		 * For EHT BSS operating channel width wider than 160 MHz,
@@ -7946,8 +7982,6 @@ static u8 * hostapd_eid_wb_channel_switch(struct hostapd_data *hapd, u8 *eid,
 			chan1 -= 16;
 		else
 			chan1 += 16;
-
-		oper_chwidth = CONF_OPER_CHWIDTH_320MHZ;
 		/* fallthrough */
 	case 160:
 		/* Update the CCFS0 and CCFS1 values in the element based on
@@ -7970,25 +8004,15 @@ static u8 * hostapd_eid_wb_channel_switch(struct hostapd_data *hapd, u8 *eid,
 		break;
 	case 80:
 		bw = 1;
-		oper_chwidth = CONF_OPER_CHWIDTH_80MHZ;
 		break;
 	case 40:
 		bw = 0;
-		oper_chwidth = CONF_OPER_CHWIDTH_USE_HT;
 		break;
 	default:
 		/* not valid VHT bandwidth or not in CSA */
 		return eid;
 	}
 
-#ifdef CONFIG_IEEE80211BE
-	if (punct_bitmap) {
-		punct_update_legacy_bw(punct_bitmap,
-				       hapd->cs_freq_params.channel,
-				       &oper_chwidth, &chan1, &chan2);
-	}
-#endif /* CONFIG_IEEE80211BE */
-
 	*eid++ = WLAN_EID_WIDE_BW_CHSWITCH;
 	*eid++ = 3; /* Length of Wide Bandwidth Channel Switch element */
 	*eid++ = bw; /* New Channel Width */
-- 
2.45.2

