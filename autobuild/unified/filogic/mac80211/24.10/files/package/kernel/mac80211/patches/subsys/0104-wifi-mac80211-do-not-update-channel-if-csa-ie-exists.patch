From 4a95e4b0a8a7a6eaf141326f61649715c90d6897 Mon Sep 17 00:00:00 2001
From: Peter Chiu <chui-hao.chiu@mediatek.com>
Date: Mon, 30 Jun 2025 13:55:14 +0800
Subject: [PATCH 104/115] wifi: mac80211: do not update channel if csa ie
 exists

Station may receive beacon ie with old channel after channel switch.
Do not update channel when CSA ie exists to prevent station
switch back to old channel and leads to disconnection.

Signed-off-by: Peter Chiu <chui-hao.chiu@mediatek.com>
---
 net/mac80211/mlme.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/net/mac80211/mlme.c b/net/mac80211/mlme.c
index 7df9270a..3e9fe3e2 100644
--- a/net/mac80211/mlme.c
+++ b/net/mac80211/mlme.c
@@ -7721,7 +7721,8 @@ static void ieee80211_rx_mgmt_beacon(struct ieee80211_link_data *link,
 
 	changed |= ieee80211_recalc_twt_req(sdata, sband, link, link_sta, elems);
 
-	if (ieee80211_config_bw(link, elems, true, &changed,
+	if (!elems->ch_switch_ie &&
+	    ieee80211_config_bw(link, elems, true, &changed,
 				IEEE80211_STYPE_BEACON)) {
 		ieee80211_set_disassoc(sdata, IEEE80211_STYPE_DEAUTH,
 				       WLAN_REASON_DEAUTH_LEAVING,
-- 
2.45.2

