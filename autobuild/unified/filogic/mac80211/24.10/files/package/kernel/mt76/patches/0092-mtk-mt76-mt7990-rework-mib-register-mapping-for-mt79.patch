From e7696feb6521436df632371082b56179b7074c55 Mon Sep 17 00:00:00 2001
From: Howard Hsu <howard-yh.hsu@mediatek.com>
Date: Fri, 18 Apr 2025 17:29:55 +0800
Subject: [PATCH 92/92] mtk: mt76: mt7990: rework mib register mapping for
 mt7990

Rework mib register offset for mt7990.

Signed-off-by: Howard Hsu <howard-yh.hsu@mediatek.com>

---
 mt7996/mmio.c        | 24 ++++++++++++++++++++++++
 mt7996/mtk_debug.h   | 30 ------------------------------
 mt7996/mtk_debugfs.c | 12 ++++++------
 mt7996/regs.h        | 24 ++++++++++++++++--------
 4 files changed, 46 insertions(+), 44 deletions(-)

diff --git a/mt7996/mmio.c b/mt7996/mmio.c
index 07b11895..7a51a821 100644
--- a/mt7996/mmio.c
+++ b/mt7996/mmio.c
@@ -58,6 +58,14 @@ static const u32 mt7996_offs[] = {
 	[MIB_BSCR7]		= 0x9e8,
 	[MIB_BSCR17]		= 0xa10,
 	[MIB_TRDR1]		= 0xa28,
+	[MIB_TSCR0]		= 0x6b0,
+	[MIB_TSCR1]		= 0x6b4,
+	[MIB_TSCR2]		= 0x6b8,
+	[MIB_TSCR3]		= 0x6bc,
+	[MIB_TSCR4]		= 0x6c0,
+	[MIB_TSCR5]		= 0x6c4,
+	[MIB_TSCR6]		= 0x6c8,
+	[MIB_TSCR7]		= 0x6d0,
 	[HIF_REMAP_L1]		= 0x24,
 	[HIF_REMAP_BASE_L1]	= 0x130000,
 	[HIF_REMAP_L2]		= 0x1b4,
@@ -95,6 +103,14 @@ static const u32 mt7992_offs[] = {
 	[MIB_BSCR7]		= 0xae4,
 	[MIB_BSCR17]		= 0xb0c,
 	[MIB_TRDR1]		= 0xb24,
+	[MIB_TSCR0]		= 0x6b0,
+	[MIB_TSCR1]		= 0x6b4,
+	[MIB_TSCR2]		= 0x6b8,
+	[MIB_TSCR3]		= 0x6bc,
+	[MIB_TSCR4]		= 0x6c0,
+	[MIB_TSCR5]		= 0x6c4,
+	[MIB_TSCR6]		= 0x6c8,
+	[MIB_TSCR7]		= 0x6d0,
 	[HIF_REMAP_L1]		= 0x8,
 	[HIF_REMAP_BASE_L1]	= 0x40000,
 	[HIF_REMAP_L2]		= 0x1b4,
@@ -132,6 +148,14 @@ static const u32 mt7990_offs[] = {
 	[MIB_BSCR7]		= 0xbd4,
 	[MIB_BSCR17]		= 0xbfc,
 	[MIB_TRDR1]		= 0xc14,
+	[MIB_TSCR0]		= 0x750,
+	[MIB_TSCR1]		= 0x754,
+	[MIB_TSCR2]		= 0x758,
+	[MIB_TSCR3]		= 0x75c,
+	[MIB_TSCR4]		= 0x760,
+	[MIB_TSCR5]		= 0x764,
+	[MIB_TSCR6]		= 0x768,
+	[MIB_TSCR7]		= 0x770,
 	[HIF_REMAP_L1]		= 0x8,
 	[HIF_REMAP_BASE_L1]	= 0x40000,
 	[HIF_REMAP_L2]		= 0x1b8,
diff --git a/mt7996/mtk_debug.h b/mt7996/mtk_debug.h
index 26b4bdd4..503fb8bd 100644
--- a/mt7996/mtk_debug.h
+++ b/mt7996/mtk_debug.h
@@ -46,12 +46,6 @@ enum dbg_offs_rev {
 	MIB_MSR2,
 	MIB_MCTR5,
 	MIB_MCTR6,
-	MIB_TSCR0,
-	MIB_TSCR3,
-	MIB_TSCR4,
-	MIB_TSCR5,
-	MIB_TSCR6,
-	MIB_TSCR7,
 	MIB_TSCR8,
 	MIB_TBCR0,
 	MIB_TBCR1,
@@ -94,12 +88,6 @@ static const u32 mt7996_dbg_offs[] = {
 	[MIB_MSR2]		= 0xa6c,
 	[MIB_MCTR5]		= 0xa70,
 	[MIB_MCTR6]		= 0xa74,
-	[MIB_TSCR0]		= 0x6b0,
-	[MIB_TSCR3]		= 0x6bc,
-	[MIB_TSCR4]		= 0x6c0,
-	[MIB_TSCR5]		= 0x6c4,
-	[MIB_TSCR6]		= 0x6c8,
-	[MIB_TSCR7]		= 0x6d0,
 	[MIB_TSCR8]		= 0x6cc,
 	[MIB_TBCR0]		= 0x6ec,
 	[MIB_TBCR1]		= 0x6f0,
@@ -141,12 +129,6 @@ static const u32 mt7992_dbg_offs[] = {
 	[MIB_MSR2]		= 0xb68,
 	[MIB_MCTR5]		= 0xb6c,
 	[MIB_MCTR6]		= 0xb70,
-	[MIB_TSCR0]		= 0x6b0,
-	[MIB_TSCR3]		= 0x6bc,
-	[MIB_TSCR4]		= 0x6c0,
-	[MIB_TSCR5]		= 0x6c4,
-	[MIB_TSCR6]		= 0x6c8,
-	[MIB_TSCR7]		= 0x6d0,
 	[MIB_TSCR8]		= 0x6cc,
 	[MIB_TBCR0]		= 0x6ec,
 	[MIB_TBCR1]		= 0x6f0,
@@ -188,12 +170,6 @@ static const u32 mt7990_dbg_offs[] = {
 	[MIB_MSR2]		= 0xc58,
 	[MIB_MCTR5]		= 0xc5c,
 	[MIB_MCTR6]		= 0xc60,
-	[MIB_TSCR0]		= 0x750,
-	[MIB_TSCR3]		= 0x75c,
-	[MIB_TSCR4]		= 0x760,
-	[MIB_TSCR5]		= 0x764,
-	[MIB_TSCR6]		= 0x768,
-	[MIB_TSCR7]		= 0x770,
 	[MIB_TSCR8]		= 0x76c,
 	[MIB_TBCR0]		= 0x78c,
 	[MIB_TBCR1]		= 0x790,
@@ -813,12 +789,6 @@ struct queue_desc {
 #define BN0_WF_MIB_TOP_BTCR_ADDR                               (BN0_WF_MIB_TOP_BASE + 0x5A0) // D5A0
 #define BN0_WF_MIB_TOP_RVSR0_ADDR                              (BN0_WF_MIB_TOP_BASE + __OFFS(MIB_RVSR0))
 
-#define BN0_WF_MIB_TOP_TSCR0_ADDR                              (BN0_WF_MIB_TOP_BASE + __DBG_OFFS(MIB_TSCR0))
-#define BN0_WF_MIB_TOP_TSCR3_ADDR                              (BN0_WF_MIB_TOP_BASE + __DBG_OFFS(MIB_TSCR3))
-#define BN0_WF_MIB_TOP_TSCR4_ADDR                              (BN0_WF_MIB_TOP_BASE + __DBG_OFFS(MIB_TSCR4))
-#define BN0_WF_MIB_TOP_TSCR5_ADDR                              (BN0_WF_MIB_TOP_BASE + __DBG_OFFS(MIB_TSCR5))
-#define BN0_WF_MIB_TOP_TSCR6_ADDR                              (BN0_WF_MIB_TOP_BASE + __DBG_OFFS(MIB_TSCR6))
-#define BN0_WF_MIB_TOP_TSCR7_ADDR                              (BN0_WF_MIB_TOP_BASE + __DBG_OFFS(MIB_TSCR7))
 #define BN0_WF_MIB_TOP_TSCR8_ADDR                              (BN0_WF_MIB_TOP_BASE + __DBG_OFFS(MIB_TSCR8))
 
 #define BN0_WF_MIB_TOP_TBCR0_ADDR                              (BN0_WF_MIB_TOP_BASE + __DBG_OFFS(MIB_TBCR0))
diff --git a/mt7996/mtk_debugfs.c b/mt7996/mtk_debugfs.c
index e057c802..50627700 100644
--- a/mt7996/mtk_debugfs.c
+++ b/mt7996/mtk_debugfs.c
@@ -818,9 +818,9 @@ static int mt7996_mibinfo_show(struct seq_file *s, void *data)
 	msr0 = mt76_rr(dev, BN0_WF_MIB_TOP_MSR0_ADDR + band_offset);
 	msr1 = mt76_rr(dev, BN0_WF_MIB_TOP_MSR1_ADDR + band_offset);
 	msr2 = mt76_rr(dev, BN0_WF_MIB_TOP_MSR2_ADDR + band_offset);
-	ampdu_cnt[0] = mt76_rr(dev, BN0_WF_MIB_TOP_TSCR0_ADDR + band_offset);
-	ampdu_cnt[1] = mt76_rr(dev, BN0_WF_MIB_TOP_TSCR3_ADDR + band_offset);
-	ampdu_cnt[2] = mt76_rr(dev, BN0_WF_MIB_TOP_TSCR4_ADDR + band_offset);
+	ampdu_cnt[0] = mt76_rr(dev, MT_MIB_TSCR0(band_idx));
+	ampdu_cnt[1] = mt76_rr(dev, MT_MIB_TSCR3(band_idx));
+	ampdu_cnt[2] = mt76_rr(dev, MT_MIB_TSCR4(band_idx));
 	ampdu_cnt[1] &= BN0_WF_MIB_TOP_TSCR3_AMPDU_MPDU_COUNT_MASK;
 	ampdu_cnt[2] &= BN0_WF_MIB_TOP_TSCR4_AMPDU_ACKED_COUNT_MASK;
 
@@ -874,10 +874,10 @@ static int mt7996_mibinfo_show(struct seq_file *s, void *data)
 
 	seq_printf(s, "===MU Related Counters===\n");
 	mu_cnt[0] = mt76_rr(dev, BN0_WF_MIB_TOP_BSCR2_ADDR + band_offset);
-	mu_cnt[1] = mt76_rr(dev, BN0_WF_MIB_TOP_TSCR5_ADDR + band_offset);
-	mu_cnt[2] = mt76_rr(dev, BN0_WF_MIB_TOP_TSCR6_ADDR + band_offset);
+	mu_cnt[1] = mt76_rr(dev, MT_MIB_TSCR5(band_idx));
+	mu_cnt[2] = mt76_rr(dev, MT_MIB_TSCR6(band_idx));
 	mu_cnt[3] = mt76_rr(dev, BN0_WF_MIB_TOP_TSCR8_ADDR + band_offset);
-	mu_cnt[4] = mt76_rr(dev, BN0_WF_MIB_TOP_TSCR7_ADDR + band_offset);
+	mu_cnt[4] = mt76_rr(dev, MT_MIB_TSCR7(band_idx));
 
 	seq_printf(s, "\tMUBF_TX_COUNT=0x%x\n",
 		mu_cnt[0] & BN0_WF_MIB_TOP_BSCR2_MUBF_TX_COUNT_MASK);
diff --git a/mt7996/regs.h b/mt7996/regs.h
index 9b60e554..03867b94 100644
--- a/mt7996/regs.h
+++ b/mt7996/regs.h
@@ -64,6 +64,14 @@ enum offs_rev {
 	MIB_BSCR7,
 	MIB_BSCR17,
 	MIB_TRDR1,
+	MIB_TSCR0,
+	MIB_TSCR1,
+	MIB_TSCR2,
+	MIB_TSCR3,
+	MIB_TSCR4,
+	MIB_TSCR5,
+	MIB_TSCR6,
+	MIB_TSCR7,
 	HIF_REMAP_L1,
 	HIF_REMAP_BASE_L1,
 	HIF_REMAP_L2,
@@ -249,9 +257,9 @@ enum offs_rev {
 #define MT_MIB_BSCR7(_band)			MT_WF_MIB(_band, __OFFS(MIB_BSCR7))
 #define MT_MIB_BSCR17(_band)			MT_WF_MIB(_band, __OFFS(MIB_BSCR17))
 
-#define MT_MIB_TSCR5(_band)			MT_WF_MIB(_band, 0x6c4)
-#define MT_MIB_TSCR6(_band)			MT_WF_MIB(_band, 0x6c8)
-#define MT_MIB_TSCR7(_band)			MT_WF_MIB(_band, 0x6d0)
+#define MT_MIB_TSCR5(_band)			MT_WF_MIB(_band, __OFFS(MIB_TSCR5))
+#define MT_MIB_TSCR6(_band)			MT_WF_MIB(_band, __OFFS(MIB_TSCR6))
+#define MT_MIB_TSCR7(_band)			MT_WF_MIB(_band, __OFFS(MIB_TSCR7))
 
 #define MT_MIB_RSCR1(_band)			MT_WF_MIB(_band, __OFFS(MIB_RSCR1))
 /* rx mpdu counter, full 32 bits */
@@ -267,14 +275,14 @@ enum offs_rev {
 #define MT_MIB_RSCR36(_band)			MT_WF_MIB(_band, __OFFS(MIB_RSCR36))
 
 /* tx ampdu cnt, full 32 bits */
-#define MT_MIB_TSCR0(_band)			MT_WF_MIB(_band, 0x6b0)
-#define MT_MIB_TSCR2(_band)			MT_WF_MIB(_band, 0x6b8)
+#define MT_MIB_TSCR0(_band)			MT_WF_MIB(_band, __OFFS(MIB_TSCR0))
+#define MT_MIB_TSCR2(_band)			MT_WF_MIB(_band, __OFFS(MIB_TSCR2))
 
 /* counts all mpdus in ampdu, regardless of success */
-#define MT_MIB_TSCR3(_band)			MT_WF_MIB(_band, 0x6bc)
+#define MT_MIB_TSCR3(_band)			MT_WF_MIB(_band, __OFFS(MIB_TSCR3))
 
 /* counts all successfully tx'd mpdus in ampdu */
-#define MT_MIB_TSCR4(_band)			MT_WF_MIB(_band, 0x6c0)
+#define MT_MIB_TSCR4(_band)			MT_WF_MIB(_band, __OFFS(MIB_TSCR4))
 
 /* rx ampdu count, 32-bit */
 #define MT_MIB_RSCR27(_band)			MT_WF_MIB(_band, __OFFS(MIB_RSCR27))
@@ -298,7 +306,7 @@ enum offs_rev {
 #define MT_MIB_RVSR1(_band)			MT_WF_MIB(_band, __OFFS(MIB_RVSR1))
 
 /* rx blockack count, 32 bits */
-#define MT_MIB_TSCR1(_band)			MT_WF_MIB(_band, 0x6b4)
+#define MT_MIB_TSCR1(_band)			MT_WF_MIB(_band, __OFFS(MIB_TSCR1))
 
 #define MT_MIB_BTSCR0(_band)			MT_WF_MIB(_band, 0x5e0)
 #define MT_MIB_BTSCR5(_band)			MT_WF_MIB(_band, __OFFS(MIB_BTSCR5))
-- 
2.45.2

