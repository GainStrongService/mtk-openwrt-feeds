From ee6be14238be5df67a25435b6484bdba08670fdf Mon Sep 17 00:00:00 2001
From: Peter Chiu <chui-hao.chiu@mediatek.com>
Date: Wed, 4 Jun 2025 13:39:37 +0800
Subject: [PATCH 094/123] mtk: mt76: per band sw token needs to consider MLO
 affiliated link case

Signed-off-by: Peter Chiu <chui-hao.chiu@mediatek.com>
---
 mt7996/mac.c | 22 ++++++++++++++++++++++
 tx.c         |  2 +-
 2 files changed, 23 insertions(+), 1 deletion(-)

diff --git a/mt7996/mac.c b/mt7996/mac.c
index 17c68e27..b377bcd2 100644
--- a/mt7996/mac.c
+++ b/mt7996/mac.c
@@ -1098,6 +1098,28 @@ int mt7996_tx_prepare_skb(struct mt76_dev *mdev, void *txwi_ptr,
 	t->wcid = wcid->idx;
 
 	id = mt76_token_consume(mdev, &t, mconf->mt76.band_idx);
+
+	if (id == -EBUSY && sta && sta->mlo) {
+		unsigned long valid_links = vif->valid_links ?: BIT(0);
+		struct mt7996_vif_link *mconf_temp;
+		unsigned int link_id_temp;
+
+		/* For MLO station, try to get token from affiliated link */
+		for_each_set_bit(link_id_temp, &valid_links,
+				 IEEE80211_MLD_MAX_NUM_LINKS) {
+			mconf_temp = (struct mt7996_vif_link *)
+				     rcu_dereference(mvif->mt76.link[link_id_temp]);
+
+			if (!mconf_temp)
+				continue;
+
+			id = mt76_token_consume(mdev, &t, mconf_temp->mt76.band_idx);
+			if (id >= 0)
+				break;
+		}
+	}
+
+
 	if (id < 0) {
 		mdev->tx_dbg_stats.tx_drop[MT_TX_DROP_GET_TOKEN_FAIL]++;
 		return id;
diff --git a/tx.c b/tx.c
index c0f4fca2..5fd81f79 100644
--- a/tx.c
+++ b/tx.c
@@ -858,7 +858,7 @@ EXPORT_SYMBOL_GPL(__mt76_set_tx_blocked);
 int mt76_token_consume(struct mt76_dev *dev, struct mt76_txwi_cache **ptxwi,
 		       u8 phy_idx)
 {
-	int token = -EINVAL, start = 0;
+	int token = -EBUSY, start = 0;
 	struct mt76_phy *phy = mt76_dev_phy(dev, phy_idx);
 
 	if (mtk_wed_device_active(&dev->mmio.wed))
-- 
2.45.2

