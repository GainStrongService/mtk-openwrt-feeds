From bf3757d72e8c49366230af2d75458feca92fe745 Mon Sep 17 00:00:00 2001
From: Peter Chiu <chui-hao.chiu@mediatek.com>
Date: Mon, 11 Aug 2025 12:41:50 +0800
Subject: [PATCH 112/123] mtk: mt76: mt7996: deny addba request when delete BA
 is not finish

MT7996 needs to delete RRO session when receiving FW command.
Deny addba request until delete BA finish to prevent removing
incorrect RRO session.

Signed-off-by: Peter Chiu <chui-hao.chiu@mediatek.com>
---
 mt7996/init.c   | 15 +++++++++++++++
 mt7996/main.c   |  4 ++++
 mt7996/mcu.c    |  1 +
 mt7996/mt7996.h |  2 ++
 4 files changed, 22 insertions(+)

diff --git a/mt7996/init.c b/mt7996/init.c
index 86362a2f..3525dcc1 100644
--- a/mt7996/init.c
+++ b/mt7996/init.c
@@ -1347,6 +1347,21 @@ reset:
 			elem->signature = 0xff;
 		}
 		mt7996_mcu_wed_rro_reset_sessions(dev, e->id);
+
+		if (is_mt7996(&dev->mt76)) {
+			struct ieee80211_sta *sta;
+			struct mt7996_sta *msta;
+			struct mt76_wcid *wcid;
+
+			rcu_read_lock();
+			wcid = rcu_dereference(dev->mt76.wcid[e->wcid]);
+			sta = wcid_to_sta(wcid);
+			if (sta) {
+				msta = (struct mt7996_sta *)sta->drv_priv;
+				msta->stop_rx_ba_in_progress = false;
+			}
+			rcu_read_unlock();
+		}
 out:
 		kfree(e);
 	}
diff --git a/mt7996/main.c b/mt7996/main.c
index d60302b9..172ec9dd 100644
--- a/mt7996/main.c
+++ b/mt7996/main.c
@@ -1771,6 +1771,10 @@ mt7996_ampdu_action(struct ieee80211_hw *hw, struct ieee80211_vif *vif,
 
 	switch (params->action) {
 	case IEEE80211_AMPDU_RX_START:
+		if (msta->stop_rx_ba_in_progress) {
+			ret = -EAGAIN;
+			break;
+		}
 		/* Since packets belonging to the same TID can be split over
 		 * multiple links, store the AMPDU state for reordering in the
 		 * primary link
diff --git a/mt7996/mcu.c b/mt7996/mcu.c
index a056da67..990978c2 100644
--- a/mt7996/mcu.c
+++ b/mt7996/mcu.c
@@ -1379,6 +1379,7 @@ mt7996_mcu_wed_rro_event(struct mt7996_dev *dev, struct sk_buff *skb)
 				break;
 
 			session->id = le16_to_cpu(e->session_id);
+			session->wcid = le16_to_cpu(e->mld_id);
 
 			spin_lock_bh(&dev->wed_rro.lock);
 			list_add_tail(&session->list, &dev->wed_rro.poll_list);
diff --git a/mt7996/mt7996.h b/mt7996/mt7996.h
index d7265ef9..70e7a5b2 100644
--- a/mt7996/mt7996.h
+++ b/mt7996/mt7996.h
@@ -459,6 +459,7 @@ struct mt7996_sta {
 	struct mt7996_vif *vif;
 	u8 sec_link;
 	u16 valid_links;
+	bool stop_rx_ba_in_progress;
 
 	unsigned long last_addba_req_time[IEEE80211_NUM_TIDS];
 };
@@ -578,6 +579,7 @@ struct mt7996_wed_rro_addr {
 struct mt7996_wed_rro_session_id {
 	struct list_head list;
 	u16 id;
+	u16 wcid;
 };
 
 struct mt7996_sta_rc_work_data {
-- 
2.45.2

