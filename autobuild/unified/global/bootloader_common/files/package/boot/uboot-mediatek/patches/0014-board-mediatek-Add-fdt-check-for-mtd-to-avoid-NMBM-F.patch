From d3ca00ad10eceb09c0cfe4e18a2ae8c84e099597 Mon Sep 17 00:00:00 2001
From: Sky Huang <skylake.huang@mediatek.com>
Date: Thu, 4 Dec 2025 16:05:22 +0800
Subject: [PATCH 14/23] board: mediatek: Add fdt check for mtd to avoid NMBM &
 Full-UBI loads cross boot

[Description]
Add fdt check for mtd:
- NMBM configuration: Must have "mediatek,nmbm" & 1 ubi mtd fixed partition.
- Full-UBI configuration: Must not have "mediatek,nmbm" & 1 ubi mtd fixed
partition.

If fdt detects 2 ubi mtd fixed partitions, it means that users overlay
both NMBM & Full-UBI kernel dtso, which is not allowed.

[Release-log]
N/A

Change-Id: I3839fd21be5226471573d9b292f4bbe69f4318fb
Signed-off-by: Sky Huang <skylake.huang@mediatek.com>
CR-Id: WCNCR00270499
---
 board/mediatek/common/bootmenu_mtd.c |  8 +++
 board/mediatek/common/bootmenu_ubi.c |  8 +++
 board/mediatek/common/mtd_helper.c   | 83 ++++++++++++++++++++++++++++
 board/mediatek/common/mtd_helper.h   |  2 +
 4 files changed, 101 insertions(+)

diff --git a/board/mediatek/common/bootmenu_mtd.c b/board/mediatek/common/bootmenu_mtd.c
index 1aad9a0fa26..c2407925a0e 100644
--- a/board/mediatek/common/bootmenu_mtd.c
+++ b/board/mediatek/common/bootmenu_mtd.c
@@ -5,6 +5,7 @@
  * Author: Weijie Gao <weijie.gao@mediatek.com>
  */
 
+#include <hang.h>
 #include "bootmenu_common.h"
 #include "autoboot_helper.h"
 #include "mtd_helper.h"
@@ -175,6 +176,13 @@ void board_bootmenu_entries(const struct bootmenu_entry **menu, u32 *count)
 
 void default_boot_set_defaults(void *fdt)
 {
+	int ret;
+
+	ret = mtd_verify_linux_fdt(fdt);
+	if (ret) {
+		hang();
+	}
+
 	mtd_boot_set_defaults(fdt);
 }
 
diff --git a/board/mediatek/common/bootmenu_ubi.c b/board/mediatek/common/bootmenu_ubi.c
index e4f385c7c11..7aa8f88d137 100644
--- a/board/mediatek/common/bootmenu_ubi.c
+++ b/board/mediatek/common/bootmenu_ubi.c
@@ -5,6 +5,7 @@
  * Author: Weijie Gao <weijie.gao@mediatek.com>
  */
 
+#include <hang.h>
 #include "bootmenu_common.h"
 #include "autoboot_helper.h"
 #include "mtd_helper.h"
@@ -172,6 +173,13 @@ void board_bootmenu_entries(const struct bootmenu_entry **menu, u32 *count)
 
 void default_boot_set_defaults(void *fdt)
 {
+	int ret;
+
+	ret = mtd_verify_linux_fdt(fdt);
+	if (ret) {
+		hang();
+	}
+
 	mtd_boot_set_defaults(fdt);
 }
 
diff --git a/board/mediatek/common/mtd_helper.c b/board/mediatek/common/mtd_helper.c
index adf28337a9a..3fc32e47e3c 100644
--- a/board/mediatek/common/mtd_helper.c
+++ b/board/mediatek/common/mtd_helper.c
@@ -9,6 +9,7 @@
 
 #include <env.h>
 #include <errno.h>
+#include <fdt_support.h>
 #include <image.h>
 #include <memalign.h>
 #include <mtd.h>
@@ -1734,3 +1735,85 @@ void mtd_boot_set_defaults(void *fdt)
 		rootdisk_set_rootfs_ubi_relax(fdt, ubi_image_vol);
 #endif
 }
+
+int mtd_verify_linux_fdt(void *fdt)
+{
+	struct mtd_info *mtd_nmbm = NULL;
+	bool uboot_is_nmbm = false;
+	bool fdt_has_nmbm = false;
+	int ubi_partition_count = 0;
+	int nodeoffset, depth, len;
+	const void *prop;
+	int partitions_node = -1;
+
+	if (!fdt)
+		return 0;
+
+	gen_mtd_probe_devices();
+	mtd_nmbm = get_mtd_device_nm("nmbm0");
+	if (!IS_ERR(mtd_nmbm)) {
+		uboot_is_nmbm = true;
+		put_mtd_device(mtd_nmbm);
+	}
+
+	nodeoffset = 0;
+	depth = 0;
+	while ((nodeoffset = fdt_next_node(fdt, nodeoffset, &depth)) >= 0) {
+		prop = fdt_getprop(fdt, nodeoffset, "mediatek,nmbm", &len);
+		if (prop) {
+			fdt_has_nmbm = true;
+		}
+
+		prop = fdt_getprop(fdt, nodeoffset, "compatible", &len);
+		if (prop && strstr((const char *)prop, "fixed-partitions")) {
+			partitions_node = nodeoffset;
+		}
+	}
+
+	/* Count UBI partitions (partitions with compatible = "linux,ubi") */
+	if (partitions_node >= 0) {
+		int child;
+		fdt_for_each_subnode(child, fdt, partitions_node) {
+			prop = fdt_getprop(fdt, child, "compatible", &len);
+			if (prop && strstr((const char *)prop, "linux,ubi")) {
+				ubi_partition_count++;
+			}
+		}
+	}
+
+	pr_debug("\nFDT verification:\n");
+	pr_debug("  U-Boot type: %s\n", uboot_is_nmbm ? "NMBM" : "Full-UBI");
+	pr_debug("  FDT contains 'mediatek,nmbm' property: %s\n", fdt_has_nmbm ? "yes" : "no");
+	pr_debug("  UBI partitions count: %d\n", ubi_partition_count);
+
+	/* Check for duplicate UBI partitions (both overlays applied) */
+	if (ubi_partition_count > 1) {
+		printf("\n");
+		cprintln(ERROR, "*** FDT Error: Duplicate UBI partitions detected! ***");
+		printf("Found %d UBI partitions - this indicates both overlays were applied\n",
+		       ubi_partition_count);
+		printf("Do NOT overlay both NMBM and Full-UBI overlays together\n\n");
+		return -EINVAL;
+	}
+
+	/* Safety check: Prevent booting with mismatched FDT */
+	if (uboot_is_nmbm) {
+		if (!fdt_has_nmbm) {
+			printf("\n");
+			cprintln(ERROR, "*** FDT Mismatch! ***");
+			printf("NMBM U-Boot requires 'mediatek,nmbm' property in FDT\n");
+			printf("Please use kernel with NMBM overlay\n\n");
+			return -EINVAL;
+		}
+	} else {
+		if (fdt_has_nmbm) {
+			printf("\n");
+			cprintln(ERROR, "*** FDT Mismatch! ***");
+			printf("Full-UBI U-Boot detected 'mediatek,nmbm' property\n");
+			printf("Please use kernel with Full-UBI overlay\n\n");
+			return -EINVAL;
+		}
+	}
+
+	return 0;
+}
diff --git a/board/mediatek/common/mtd_helper.h b/board/mediatek/common/mtd_helper.h
index 0296f1eb28b..010cd04b685 100644
--- a/board/mediatek/common/mtd_helper.h
+++ b/board/mediatek/common/mtd_helper.h
@@ -56,4 +56,6 @@ int mtd_upgrade_standalone_image(const char *name, bool bypass_ubi,
 
 void mtd_boot_set_defaults(void *fdt);
 
+int mtd_verify_linux_fdt(void *fdt);
+
 #endif /* _MTD_HELPER_H_ */
-- 
2.45.2

