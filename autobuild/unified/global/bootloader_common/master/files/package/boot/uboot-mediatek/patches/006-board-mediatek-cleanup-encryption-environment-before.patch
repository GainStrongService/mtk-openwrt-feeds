
Change-Id: I31fe3569db45e5d9ede758d181edb96976b7c4fd
---
 board/mediatek/common/Makefile      |  1 +
 board/mediatek/common/boot_helper.c |  7 +++++++
 board/mediatek/common/fw_dec.c      | 18 ++++++++++++++++++
 board/mediatek/common/fw_dec.h      | 11 +++++++++++
 4 files changed, 37 insertions(+)
 create mode 100644 board/mediatek/common/fw_dec.c
 create mode 100644 board/mediatek/common/fw_dec.h

Change-Id: I31fe3569db45e5d9ede758d181edb96976b7c4fd
--- a/board/mediatek/common/Makefile
+++ b/board/mediatek/common/Makefile
@@ -53,5 +53,6 @@ obj-$(CONFIG_ENABLE_NAND_NMBM) += nmbm.o

 obj-$(CONFIG_MTK_MISC_CUSTOMIZED) += customizations/

+obj-$(CONFIG_MTK_FW_ENCRYPT) += fw_dec.o
 obj-$(CONFIG_MTK_FW_ENCRYPT_VIA_BL31) += mtk_aes_decrypt.o
 obj-$(CONFIG_MTK_FW_ENCRYPT_VIA_OPTEE) += mtk_optee_aes_decrypt.o

Change-Id: I31fe3569db45e5d9ede758d181edb96976b7c4fd
--- a/board/mediatek/common/boot_helper.c
+++ b/board/mediatek/common/boot_helper.c
@@ -21,6 +21,7 @@
 #include "boot_helper.h"
 #include "dual_boot.h"
 #include "dm_parser.h"
+#include "fw_dec.h"

 #define ARGLIST_INCR				20

@@ -632,6 +633,12 @@ void board_prep_linux(struct bootm_heade
 	u32 newlen;
 	int ret;

+#ifdef CONFIG_MTK_FW_ENCRYPT
+	ret = fw_dec_cleanup();
+	if (ret)
+		panic("Cannot cleanup FW encryption environment\n");
+#endif
+
 	if (!(CONFIG_IS_ENABLED(OF_LIBFDT) && images->ft_len)) {
 		printf("Warning: no FDT present for current image!\n");
 		return;

Change-Id: I31fe3569db45e5d9ede758d181edb96976b7c4fd
--- /dev/null
+++ b/board/mediatek/common/fw_dec.c
@@ -0,0 +1,18 @@
+// SPDX-License-Identifier: GPL-2.0+
+/*
+ * Copyright (C) 2025 MediaTek Incorporation. All Rights Reserved.
+ *
+ */
+
+#include <linux/arm-smccc.h>
+
+#define MTK_SIP_FW_DEC_CLEANUP			0xC2000584
+
+int fw_dec_cleanup(void)
+{
+	struct arm_smccc_res res = { 0 };
+
+	arm_smccc_smc(MTK_SIP_FW_DEC_CLEANUP, 0, 0, 0, 0, 0, 0, 0, &res);
+
+	return res.a0;
+}

Change-Id: I31fe3569db45e5d9ede758d181edb96976b7c4fd
--- /dev/null
+++ b/board/mediatek/common/fw_dec.h
@@ -0,0 +1,11 @@
+/* SPDX-License-Identifier: GPL-2.0 */
+/*
+ * Copyright (C) 2025 MediaTek Inc. All Rights Reserved.
+ *
+ */
+#ifndef _FW_DEC_H_
+#define _FW_DEC_H_
+
+int fw_dec_cleanup(void);
+
+#endif /* _FW_DEC_H_ */
