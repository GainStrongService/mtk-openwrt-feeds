From 0144d6422bca04c605cef6ce010f688bb3e0be8e Mon Sep 17 00:00:00 2001
From: Allen Ye <allen.ye@mediatek.com>
Date: Tue, 3 Jun 2025 11:34:45 +0800
Subject: [PATCH] Add mt76 openwrt-25.12 supprot

Signed-off-by: Allen Ye <allen.ye@mediatek.com>
---
 Makefile                  |  9 ++--
 indigo_api_callback_dut.c | 18 +++++++-
 vendor_specific.h         | 12 +++---
 vendor_specific_dut.c     | 90 ++++++++++++++++++++++-----------------
 4 files changed, 77 insertions(+), 52 deletions(-)

diff --git a/Makefile b/Makefile
index ccbf797..7204c5a 100644
--- a/Makefile
+++ b/Makefile
@@ -1,5 +1,5 @@
 # Type is laptop or openwrt
-TYPE = laptop
+TYPE = openwrt
 # Role is dut or platform or sniffer
 ROLE = dut
 # Package Version
@@ -21,11 +21,12 @@ else
 #CC = /openwrt/11305r3/qsdk/staging_dir/toolchain-aarch64_cortex-a53_gcc-5.2.0_musl-1.1.16/bin/aarch64-openwrt-linux-gcc
 #LD = /openwrt/11305r3/qsdk/staging_dir/toolchain-aarch64_cortex-a53_gcc-5.2.0_musl-1.1.16/bin/aarch64-openwrt-linux-ld
 # Wi-Fi 7
-CC = /openwrt/qsdk/staging_dir/toolchain-aarch64/bin/aarch64-openwrt-linux-musl-gcc
-LD = /openwrt/qsdk/staging_dir/toolchain-aarch64/bin/aarch64-openwrt-linux-ld
 # _OPENWRT_: Use OPENWRT
+CROSS_COMPILE = mipsel-linux-
+#CC = $(CROSS_COMPILE)gcc
+#LD = $(CROSS_COMPILE)
 CFLAGS += -D_OPENWRT_
-CFLAGS += -DHOSTAPD_SUPPORT_MBSSID_WAR
+CFLAGS += -DHOSTAPD_SUPPORT_MBSSID
 CFLAGS += -DSUPPORT_THROUGHPUT_TEST
 endif
 
diff --git a/indigo_api_callback_dut.c b/indigo_api_callback_dut.c
index cfef0aa..4033a6b 100644
--- a/indigo_api_callback_dut.c
+++ b/indigo_api_callback_dut.c
@@ -318,6 +318,7 @@ static int generate_hostapd_config(char *output, int output_size, struct packet_
     int hs20_icons_attached = 0;
     int is_multiple_bssid = 0;
     int enable_be = 0, enable_beacon_prot = 0;
+    int enable_n = 0;
 
 #if HOSTAPD_SUPPORT_MBSSID
     if ((wlanp->mbssid_enable && !wlanp->transmitter) || (band_first_wlan[wlanp->band] && !wlanp->link_conf_file[0])) {
@@ -369,6 +370,9 @@ static int generate_hostapd_config(char *output, int output_size, struct packet_
             continue;
         }
 
+        if (tlv->id == TLV_IEEE80211_N)
+            enable_n = 1;
+
         /* This is used when hostapd will use multiple lines to 
          * configure multiple items in the same configuration parameter
          * (use semicolon to separate multiple configurations) */
@@ -501,6 +505,12 @@ static int generate_hostapd_config(char *output, int output_size, struct packet_
             continue;
         }
 
+        if (tlv->id == TLV_HE_OPER_CHWIDTH || tlv->id == TLV_VHT_OPER_CHWIDTH) {
+            memset(value, 0, sizeof(value));
+            memcpy(value, tlv->value, tlv->len);
+            chwidth = atoi(value);
+        }
+
         cfg = find_tlv_config(tlv->id);
         if (!cfg) {
             indigo_logger(LOG_LEVEL_ERROR, "Unknown AP configuration name: TLV ID 0x%04x", tlv->id);
@@ -809,6 +819,10 @@ static int generate_hostapd_config(char *output, int output_size, struct packet_
         strcat(output, "local_pwr_constraint=3\n");
     }
 #endif
+
+    if (enable_n)
+        strcat(output, "noscan=1\n");
+
     if (enable_hs20) {
         strcat(output, "hs20_release=3\n");
         strcat(output, "manage_p2p=1\n");
@@ -1686,7 +1700,7 @@ static int send_ap_btm_handler(struct packet_wrapper *req, struct packet_wrapper
     /*  disassoc_imminent=%s */
     if (strlen(disassoc_imminent)) {
         memset(buffer, 0, sizeof(buffer));
-        sprintf(buffer, " disassoc_imminent=%s", disassoc_imminent);
+        sprintf(buffer, " disassoc_imminent=%s mbo_cert=1", disassoc_imminent);
         strcat(request, buffer);
     }
     /* disassoc_timer=%s */
@@ -3474,7 +3488,7 @@ static int start_wps_ap_handler(struct packet_wrapper *req, struct packet_wrappe
         /* Please implement the wsc pin validation function to
          * identify the invalid PIN code and DONOT start wps.
          * */
-        #define WPS_PIN_VALIDATION_FILE "/tmp/pin_checksum.sh"
+        #define WPS_PIN_VALIDATION_FILE "/sbin/pin_checksum.sh"
         int len = 0, is_valid = 0;
         char pipebuf[S_BUFFER_LEN];
         char *parameter[] = {"sh", WPS_PIN_VALIDATION_FILE, pin_code, NULL};
diff --git a/vendor_specific.h b/vendor_specific.h
index 3de52e5..33a80e0 100644
--- a/vendor_specific.h
+++ b/vendor_specific.h
@@ -34,18 +34,18 @@
 #endif /* _OPENWRT_ */
 #endif /* _DUT_ */
 #define HAPD_CTRL_PATH_DEFAULT                      "/var/run/hostapd"
-#define HAPD_GLOBAL_CTRL_PATH_DEFAULT               "/var/run/hostapd-global"
+#define HAPD_GLOBAL_CTRL_PATH_DEFAULT               "/var/run/hostapd/global"
 #define HAPD_LOG_FILE                               "/var/log/hostapd.log"
 
 #ifdef _OPENWRT_
-#define HAPD_CONF_FILE_DEFAULT                      "/tmp/hostapd.conf"
-#define HAPD_CONF_FILE_DEFAULT_PATH                 "/tmp"
-#define WPAS_CONF_FILE_DEFAULT                      "/tmp/wpa_supplicant.conf"
+#define HAPD_CONF_FILE_DEFAULT                      "/tmp/run/hostapd-phy0.0.conf"
+#define HAPD_CONF_FILE_DEFAULT_PATH                 "/tmp/run"
+#define WPAS_CONF_FILE_DEFAULT                      "/tmp/run/wpa_supplicant.conf"
 // 2(2.4G): first interface ath1, second interface ath11
 // 5(5G): first interface ath0, second interface ath01
 #define DEFAULT_APP_INTERFACES_PARAMS               "2:ath1,2:ath11,2:ath12,2:ath13,5:ath0,5:ath01,5:ath02,5:ath03"
-#define DEFAULT_APP_6E_INTERFACES_PARAMS            "6:ath0,6:ath01,6:ath02,6:ath03,5:ath1,5:ath11,5:ath12,5:ath13,2:ath2,2:ath21,2:ath22,2:ath23"
-#define WIFI7_PHY_INTERFACE                         "phy00"
+#define DEFAULT_APP_6E_INTERFACES_PARAMS            "2:phy0.0-ap0,2:phy0.0-ap1,5:phy0.1-ap0,5:phy0.1-ap1,6:phy0.2-ap0,6:phy0.2-ap1"
+#define WIFI7_PHY_INTERFACE                         "phy0"
 
 #else
 #define HAPD_CONF_FILE_DEFAULT                      "/etc/hostapd/hostapd.conf"
diff --git a/vendor_specific_dut.c b/vendor_specific_dut.c
index 4d598b9..1cfd230 100644
--- a/vendor_specific_dut.c
+++ b/vendor_specific_dut.c
@@ -33,10 +33,10 @@ int detect_number_radio() {
     char buffer[BUFFER_LEN];
     int number_radio = 0;
 
-    fp = popen("iw dev", "r");
+    fp = popen("iw phy | grep 'Wiphy phy'", "r");
     if (fp) {
         while (fgets(buffer, sizeof(buffer), fp) != NULL) {
-            if (strstr(buffer, "phy#0") || strstr(buffer, "phy#1") || strstr(buffer, "phy#2"))
+            if (strstr(buffer, "Wiphy phy"))
                 number_radio += 1;
         }
         pclose(fp);
@@ -60,61 +60,61 @@ void interfaces_init() {
         sprintf(phy_name, WIFI7_PHY_INTERFACE);
     else
         sprintf(phy_name, "phy1");
-    sprintf(buffer, "iw phy %s interface add ath1 type managed >/dev/null 2>/dev/null", phy_name);
+    sprintf(buffer, "iw phy %s interface add phy0.1-ap0 type __ap >/dev/null 2>/dev/null", phy_name);
     system(buffer);
-    sprintf(buffer, "iw phy %s interface add ath11 type managed >/dev/null 2>/dev/null", phy_name);
+    sprintf(buffer, "iw phy %s interface add phy0.1-ap1 type __ap >/dev/null 2>/dev/null", phy_name);
     system(buffer);
     if (number_radio != 1)
         sprintf(phy_name, "phy0");
-    sprintf(buffer, "iw phy %s interface add ath0 type managed >/dev/null 2>/dev/null", phy_name);
+    sprintf(buffer, "iw phy %s interface add phy0.0-ap0 type __ap >/dev/null 2>/dev/null", phy_name);
     system(buffer);
-    sprintf(buffer, "iw phy %s interface add ath01 type managed >/dev/null 2>/dev/null", phy_name);
+    sprintf(buffer, "iw phy %s interface add phy0.0-ap1 type __ap >/dev/null 2>/dev/null", phy_name);
     system(buffer);
     if (number_radio == 1 || number_radio == 3) {
         if (number_radio != 1)
             sprintf(phy_name, "phy2");
-        sprintf(buffer, "iw phy %s interface add ath2 type managed >/dev/null 2>/dev/null", phy_name);
+        sprintf(buffer, "iw phy %s interface add phy0.2-ap0 type __ap >/dev/null 2>/dev/null", phy_name);
         system(buffer);
-        sprintf(buffer, "iw phy %s interface add ath21 type managed >/dev/null 2>/dev/null", phy_name);
+        sprintf(buffer, "iw phy %s interface add phy0.2-ap1 type __ap >/dev/null 2>/dev/null", phy_name);
         system(buffer);
     }
 
     memset(mac_addr, 0, sizeof(mac_addr));
-    get_mac_address(mac_addr, sizeof(mac_addr), "ath1");
-    control_interface("ath1", "down");
+    get_mac_address(mac_addr, sizeof(mac_addr), "phy0.1-ap0");
+    control_interface("phy0.1-ap0", "down");
     mac_addr[16] = (char)'0';
-    set_mac_address("ath1", mac_addr);
+    set_mac_address("phy0.1-ap0", mac_addr);
 
-    control_interface("ath11", "down");
+    control_interface("phy0.1-ap1", "down");
     mac_addr[16] = (char)'1';
-    set_mac_address("ath11", mac_addr);
+    set_mac_address("phy0.1-ap1", mac_addr);
 
     memset(mac_addr, 0, sizeof(mac_addr));
-    get_mac_address(mac_addr, sizeof(mac_addr), "ath0");
-    control_interface("ath0", "down");
+    get_mac_address(mac_addr, sizeof(mac_addr), "phy0.0-ap0");
+    control_interface("phy0.0-ap0", "down");
     if (number_radio == 1)
         mac_addr[16] = (char)'4';
     else
         mac_addr[16] = (char)'0';
-    set_mac_address("ath0", mac_addr);
+    set_mac_address("phy0.0-ap0", mac_addr);
 
-    control_interface("ath01", "down");
+    control_interface("phy0.0-ap1", "down");
     if (number_radio == 1)
         mac_addr[16] = (char)'5';
     else
         mac_addr[16] = (char)'1';
-    set_mac_address("ath01", mac_addr);
+    set_mac_address("phy0.0-ap1", mac_addr);
 
     if (number_radio == 1 || number_radio == 3) {
         memset(mac_addr, 0, sizeof(mac_addr));
-        get_mac_address(mac_addr, sizeof(mac_addr), "ath2");
-        control_interface("ath2", "down");
+        get_mac_address(mac_addr, sizeof(mac_addr), "phy0.2-ap0");
+        control_interface("phy0.2-ap0", "down");
         mac_addr[16] = (char)'8';
-        set_mac_address("ath2", mac_addr);
+        set_mac_address("phy0.2-ap0", mac_addr);
 
-        control_interface("ath21", "down");
+        control_interface("phy0.2-ap1", "down");
         mac_addr[16] = (char)'9';
-        set_mac_address("ath21", mac_addr);
+        set_mac_address("phy0.2-ap1", mac_addr);
     }
     sleep(1);
 #endif
@@ -125,6 +125,9 @@ void vendor_init() {
     char buffer[BUFFER_LEN];
     char mac_addr[S_BUFFER_LEN];
 
+    snprintf(buffer, sizeof(buffer), "fw3 stop 2> /dev/null");
+    system(buffer);
+
     /* Vendor: add codes to let ControlApp have full control of hostapd */
     /* Avoid hostapd being invoked by procd */
     memset(buffer, 0, sizeof(buffer));
@@ -455,8 +458,8 @@ wps_setting* get_vendor_wps_settings(enum wps_device_role role)
     /*
      * Please implement the vendor proprietary function to get WPS OOB and required settings.
      * */
-#define WSC_SETTINGS_FILE_AP "/tmp/wsc_settings_APUT"
-#define WSC_SETTINGS_FILE_STA "/tmp/wsc_settings_STAUT"
+#define WSC_SETTINGS_FILE_AP "/etc/wsc_settings_APUT"
+#define WSC_SETTINGS_FILE_STA "/etc/wsc_settings_STAUT"
     int len = 0, is_valid = 0;
     char pipebuf[S_BUFFER_LEN];
     char *parameter_ap[] = {"cat", WSC_SETTINGS_FILE_AP, NULL, NULL};
@@ -520,23 +523,30 @@ void get_mld_link_mac(char *mac_addr, size_t size, char *band) {
             if (ptr != NULL) {
                 sscanf(ptr, "%*s %s", name);
                 if (!strncmp(name, if_name, strlen(if_name))) {
-                    /* link 0:
-                         addr 00:03:7f:12:66:60
-                         channel 36 (5180 MHz), width: 80 MHz, center1: 5210 MHz
-                         txpower 28.00 dBm
+                    /* MLD with links:
+                        - link ID  0 link addr 00:0c:43:2b:b3:54
+                        channel 6 (2437 MHz), width: 20 MHz, center1: 2437 MHz
+                        txpower 30.00 dBm
+                        - link ID  1 link addr 02:0c:43:f3:ca:6d
+                        channel 36 (5180 MHz), width: 20 MHz, center1: 5180 MHz
+                        txpower 30.00 dBm
                     */
                     while (fgets(buffer, sizeof(buffer), fp) != NULL) {
-                        ptr = strstr(buffer, "link");
-                        if (ptr != NULL) {
-                            fgets(buffer, sizeof(buffer), fp);
-                            sscanf(buffer, "%*s %s", addr);
-                            fgets(buffer, sizeof(buffer), fp);
-                            ptr = strchr(buffer, '(');
-                            sscanf(ptr+1, "%d", &freq);
-                            if (verify_band_from_freq(freq, band_id) == 0) {
-                                snprintf(mac_addr, size, "%s", addr);
-                                break;
-                            }
+                        ptr = strstr(buffer, "- link ID ");
+                        if (!ptr)
+                            continue;
+
+                        sscanf(buffer, "%*s link ID  %*d link addr %17s", addr);
+                        addr[17] = '\0';
+                        fgets(buffer, sizeof(buffer), fp);
+                        ptr = strchr(buffer, '(');
+                        if (!ptr)
+                            continue;
+
+                        sscanf(ptr+1, "%d", &freq);
+                        if (verify_band_from_freq(freq, band_id) == 0) {
+                            snprintf(mac_addr, size, "%s", addr);
+                            break;
                         }
                     }
                     if (mac_addr[0])
-- 
2.45.2

